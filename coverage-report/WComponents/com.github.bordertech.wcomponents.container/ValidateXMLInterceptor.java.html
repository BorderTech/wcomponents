<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../resources/report.gif" type="image/gif"/><title>ValidateXMLInterceptor.java</title><link rel="stylesheet" href="../../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">WComponents Coverage</a> &gt; <a href="../index.html" class="el_bundle">WComponents</a> &gt; <a href="index.source.html" class="el_package">com.github.bordertech.wcomponents.container</a> &gt; <span class="el_source">ValidateXMLInterceptor.java</span></div><h1>ValidateXMLInterceptor.java</h1><pre class="source lang-java linenums">package com.github.bordertech.wcomponents.container;

import com.github.bordertech.wcomponents.DebugValidateXML;
import com.github.bordertech.wcomponents.RenderContext;
import com.github.bordertech.wcomponents.UIContextHolder;
import com.github.bordertech.wcomponents.WebUtilities;
import com.github.bordertech.wcomponents.servlet.WebXmlRenderContext;
import java.io.PrintWriter;
import java.io.StringWriter;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * &lt;p&gt;
 * An Interceptor used to report any WComponent that has generated HTML/XML that is not well formed.
 * &lt;/p&gt;
 * &lt;p&gt;
 * To enable this Interceptor, both &quot;bordertech.wcomponents.debug.enabled&quot; and
 * &quot;bordertech.wcomponents.debug.validateXML.enabled&quot; must be set to true.
 * &lt;/p&gt;
 * &lt;p&gt;
 * The Interceptor calls {@link DebugValidateXML} to determine if XML Validation is enabled. If it has been enabled,
 * then the interceptor uses a temporary buffer to hold the original response so that if {@link DebugValidateXML} has
 * reported errors, it can wrap the original response in a CDATA section and include any error messages in a new
 * response.
 * &lt;/p&gt;
 *
 * @author Jonathan Austin
 * @since 1.0.0
 */
<span class="fc" id="L31">public class ValidateXMLInterceptor extends InterceptorComponent {</span>

	/**
	 * The logger instance for this class.
	 */
<span class="fc" id="L36">	private static final Log LOG = LogFactory.getLog(ValidateXMLInterceptor.class);</span>

	/**
	 * Override paint to include XML Validation.
	 *
	 * @param renderContext the renderContext to send the output to.
	 */
	@Override
	public void paint(final RenderContext renderContext) {
		// Check interceptor is enabled
<span class="fc bfc" id="L46" title="All 2 branches covered.">		if (!DebugValidateXML.isEnabled()) {</span>
<span class="fc" id="L47">			super.paint(renderContext);</span>
<span class="fc" id="L48">			return;</span>
		}

<span class="fc bfc" id="L51" title="All 2 branches covered.">		if (!(renderContext instanceof WebXmlRenderContext)) {</span>
<span class="fc" id="L52">			LOG.warn(&quot;Unable to validate against a &quot; + renderContext);</span>
<span class="fc" id="L53">			super.paint(renderContext);</span>
<span class="fc" id="L54">			return;</span>
		}

<span class="fc" id="L57">		LOG.debug(&quot;Validate XML Interceptor: Start&quot;);</span>

<span class="fc" id="L59">		WebXmlRenderContext webRenderContext = (WebXmlRenderContext) renderContext;</span>
<span class="fc" id="L60">		PrintWriter writer = webRenderContext.getWriter();</span>

		// Generate XML
<span class="fc" id="L63">		StringWriter tempBuffer = new StringWriter();</span>
<span class="fc" id="L64">		PrintWriter tempWriter = new PrintWriter(tempBuffer);</span>
<span class="fc" id="L65">		WebXmlRenderContext tempContext = new WebXmlRenderContext(tempWriter, UIContextHolder.</span>
<span class="fc" id="L66">				getCurrent().getLocale());</span>

<span class="fc" id="L68">		super.paint(tempContext);</span>
<span class="fc" id="L69">		String xml = tempBuffer.toString();</span>

		// If no errors, check against the schema
<span class="fc" id="L72">		String error = DebugValidateXML.validateXMLAgainstSchema(xml);</span>

<span class="fc bfc" id="L74" title="All 2 branches covered.">		if (error != null) {</span>
			// XML is NOT valid, so Report Errors and Wrap the original XML
<span class="fc" id="L76">			LOG.debug(&quot;Validate XML Interceptor: XML Has Errors&quot;);</span>
<span class="fc" id="L77">			writer.println(&quot;&lt;div&gt;&quot;);</span>

<span class="fc" id="L79">			writer.println(&quot;&lt;div&gt;&quot;);</span>
<span class="fc" id="L80">			writer.println(&quot;Invalid XML&quot;);</span>
<span class="fc" id="L81">			writer.println(&quot;&lt;ul&gt;&lt;li&gt;&quot; + WebUtilities.encode(error) + &quot;&lt;/li&gt;&lt;/ul&gt;&quot;);</span>
<span class="fc" id="L82">			writer.println(&quot;&lt;br/&gt;&quot;);</span>
<span class="fc" id="L83">			writer.println(&quot;&lt;/div&gt;&quot;);</span>

			// If a schema error detected, Wrap XML so line numbers reported in validation message are correct
<span class="fc" id="L86">			String testXML = DebugValidateXML.wrapXMLInRootElement(xml);</span>
<span class="fc" id="L87">			paintOriginalXML(testXML, writer);</span>

<span class="fc" id="L89">			writer.println(&quot;&lt;/div&gt;&quot;);</span>
<span class="fc" id="L90">		} else {</span>
			// XML is valid
<span class="fc" id="L92">			writer.write(xml);</span>
		}

<span class="fc" id="L95">		LOG.debug(&quot;Validate XML Interceptor: Finished&quot;);</span>
<span class="fc" id="L96">	}</span>

	/**
	 * Paint the original XML wrapped in a CDATA Section.
	 *
	 * @param originalXML the original XML
	 * @param writer the output writer
	 */
	private void paintOriginalXML(final String originalXML, final PrintWriter writer) {
		// Replace any CDATA Sections embedded in XML
<span class="fc" id="L106">		String xml = originalXML.replaceAll(&quot;&lt;!\\[CDATA\\[&quot;, &quot;CDATASTART&quot;);</span>
<span class="fc" id="L107">		xml = xml.replaceAll(&quot;\\]\\]&gt;&quot;, &quot;CDATAFINISH&quot;);</span>

		// Paint Output
<span class="fc" id="L110">		writer.println(&quot;&lt;div&gt;&quot;);</span>
<span class="fc" id="L111">		writer.println(&quot;&lt;!-- VALIDATE XML ERROR - START XML --&gt;&quot;);</span>
<span class="fc" id="L112">		writer.println(&quot;&lt;![CDATA[&quot;);</span>
<span class="fc" id="L113">		writer.println(xml);</span>
<span class="fc" id="L114">		writer.println(&quot;]]&gt;&quot;);</span>
<span class="fc" id="L115">		writer.println(&quot;&lt;!-- VALIDATE XML ERROR - END XML --&gt;&quot;);</span>
<span class="fc" id="L116">		writer.println(&quot;&lt;/div&gt;&quot;);</span>
<span class="fc" id="L117">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>