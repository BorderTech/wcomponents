<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../resources/report.gif" type="image/gif"/><title>ThumbnailUtil.java</title><link rel="stylesheet" href="../../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">WComponents Coverage</a> &gt; <a href="../index.html" class="el_bundle">WComponents</a> &gt; <a href="index.source.html" class="el_package">com.github.bordertech.wcomponents.util.thumbnail</a> &gt; <span class="el_source">ThumbnailUtil.java</span></div><h1>ThumbnailUtil.java</h1><pre class="source lang-java linenums">package com.github.bordertech.wcomponents.util.thumbnail;

// Standard Java Libraries.
import com.github.bordertech.wcomponents.ImageResource;
import java.awt.Dimension;
import java.awt.Graphics2D;
import java.awt.Image;
import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import javax.imageio.ImageIO;
import javax.imageio.stream.MemoryCacheImageInputStream;
import javax.imageio.stream.MemoryCacheImageOutputStream;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * A utility class used for thumbnails.
 *
 * @author Jonathan Austin
 */
public final class ThumbnailUtil {

	/**
	 * Default thumbnail size. Scale to 64 high.
	 */
<span class="nc" id="L29">	private static final Dimension THUMBNAIL_SCALE_SIZE = new Dimension(-1, 64);</span>

	/**
	 * Default thumbnail size.
	 */
<span class="nc" id="L34">	private static final Dimension THUMBNAIL_DEFAULT_SIZE = new Dimension(64, 64);</span>

	/**
	 * Thumbnail for ms-word.
	 */
<span class="nc" id="L39">	public static final ImageResource THUMBNAIL_MSWORD = new ImageResource(</span>
			&quot;/icons/thumbnails/application-msword.png&quot;,
			&quot;msword&quot;, THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for pdf.
	 */
<span class="nc" id="L46">	public static final ImageResource THUMBNAIL_PDF = new ImageResource(</span>
			&quot;/icons/thumbnails/application-pdf.png&quot;, &quot;pdf&quot;,
			THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for ms-excel.
	 */
<span class="nc" id="L53">	public static final ImageResource THUMBNAIL_MSEXCEL = new ImageResource(</span>
			&quot;/icons/thumbnails/application-vnd.ms-excel.png&quot;,
			&quot;msexcel&quot;, THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for ms-powerpoint.
	 */
<span class="nc" id="L60">	public static final ImageResource THUMBNAIL_MSPPT = new ImageResource(</span>
			&quot;/icons/thumbnails/application-vnd.ms-powerpoint.png&quot;,
			&quot;mspowerpoint&quot;, THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for compress.
	 */
<span class="nc" id="L67">	public static final ImageResource THUMBNAIL_COMPRESS = new ImageResource(</span>
			&quot;/icons/thumbnails/application-x-compress.png&quot;,
			&quot;compress&quot;, THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for audio.
	 */
<span class="nc" id="L74">	public static final ImageResource THUMBNAIL_AUDIO = new ImageResource(</span>
			&quot;/icons/thumbnails/audio-x-generic.png&quot;,
			&quot;audio&quot;, THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for generic image.
	 */
<span class="nc" id="L81">	public static final ImageResource THUMBNAIL_IMAGE = new ImageResource(</span>
			&quot;/icons/thumbnails/image-x-generic.png&quot;,
			&quot;image&quot;, THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for misc.
	 */
<span class="nc" id="L88">	public static final ImageResource THUMBNAIL_MISC = new ImageResource(</span>
			&quot;/icons/thumbnails/misc.png&quot;, &quot;misc&quot;,
			THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for text.
	 */
<span class="nc" id="L95">	public static final ImageResource THUMBNAIL_TEXT = new ImageResource(</span>
			&quot;/icons/thumbnails/text-x-generic.png&quot;,
			&quot;text&quot;, THUMBNAIL_DEFAULT_SIZE);

	/**
	 * Thumbnail for video.
	 */
<span class="nc" id="L102">	public static final ImageResource THUMBNAIL_VIDEO = new ImageResource(</span>
			&quot;/icons/thumbnails/video-x-generic.png&quot;,
			&quot;video&quot;, THUMBNAIL_DEFAULT_SIZE);

	/**
	 * The logger instance for this class.
	 */
<span class="nc" id="L109">	private static final Log LOG = LogFactory.getLog(ThumbnailUtil.class);</span>

	/**
	 * The &quot;format&quot; passed to {@link ImageIO} to indicate that it should create a JPEG image.
	 */
	private static final String IMAGE_JPEG_FORMAT = &quot;jpeg&quot;;

	/**
	 * Don't allow this utility class to be constructed.
	 */
<span class="nc" id="L119">	private ThumbnailUtil() {</span>
		// NO-OP.
<span class="nc" id="L121">	}</span>

	/**
	 * This method takes a input document (represented by an {@link InputStream}) and returns a byte[] representing a
	 * JPEG &quot;thumb nail&quot; of a given page of the document. It can do this for a limited number of input document
	 * &quot;types&quot;images.
	 *
	 * @param is The {@link InputStream} representing the input document.
	 * @param name The name of the file from which the input document was sourced.
	 * @param scaledSize the size to which the given &lt;em&gt;image&lt;/em&gt; is to be scaled, null for default
	 * @param mimeType the mime type
	 * @return a byte[] array representing a JEPG thumb nail of the specified page within the Office document or Image.
	 */
	public static com.github.bordertech.wcomponents.Image createThumbnail(final InputStream is,
			final String name,
			final Dimension scaledSize, final String mimeType) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">		final Dimension scale = scaledSize == null ? THUMBNAIL_SCALE_SIZE : scaledSize;</span>

		// Generate thumbnail for image files
<span class="nc bnc" id="L140" title="All 8 branches missed.">		if (is != null &amp;&amp; mimeType != null &amp;&amp; (mimeType.equals(&quot;image/jpeg&quot;) || mimeType.equals(</span>
				&quot;image/bmp&quot;)
<span class="nc bnc" id="L142" title="All 4 branches missed.">				|| mimeType.equals(&quot;image/png&quot;) || mimeType.equals(&quot;image/gif&quot;))) {</span>
<span class="nc" id="L143">			byte[] bytes = createImageThumbnail(is, scale);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			if (bytes != null) {</span>
<span class="nc" id="L145">				return new BytesImage(bytes, &quot;image/jpeg&quot;, &quot;Thumbnail of &quot; + name, null);</span>
			}
		}

		// Use default thumbnail depending on mime type
<span class="nc" id="L150">		com.github.bordertech.wcomponents.Image image = handleDefaultImage(mimeType, name, scale);</span>
<span class="nc" id="L151">		return image;</span>
	}

	/**
	 * @param mimeType the files mime type
	 * @param name the file name
	 * @param scale the thumbnail size
	 * @return the thumbnail
	 */
	private static com.github.bordertech.wcomponents.Image handleDefaultImage(final String mimeType,
			final String name,
			final Dimension scale) {
		com.github.bordertech.wcomponents.Image image;
<span class="nc bnc" id="L164" title="All 2 branches missed.">		if (mimeType == null) {</span>
<span class="nc" id="L165">			image = THUMBNAIL_MISC;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">		} else if (mimeType.equals(&quot;application/pdf&quot;)) {</span>
<span class="nc" id="L167">			image = THUMBNAIL_PDF;</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">		} else if (mimeType.equals(&quot;application/msword&quot;)) {</span>
<span class="nc" id="L169">			image = THUMBNAIL_MSWORD;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">		} else if (mimeType.equals(&quot;application/vnd.ms-excel&quot;)) {</span>
<span class="nc" id="L171">			image = THUMBNAIL_MSEXCEL;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">		} else if (mimeType.equals(&quot;application/vnd.ms-powerpoint&quot;)) {</span>
<span class="nc" id="L173">			image = THUMBNAIL_MSPPT;</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">		} else if (mimeType.equals(&quot;application/zip&quot;)) {</span>
<span class="nc" id="L175">			image = THUMBNAIL_COMPRESS;</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">		} else if (mimeType.startsWith(&quot;text&quot;)) {</span>
<span class="nc" id="L177">			image = THUMBNAIL_TEXT;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">		} else if (mimeType.startsWith(&quot;audio&quot;)) {</span>
<span class="nc" id="L179">			image = THUMBNAIL_AUDIO;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">		} else if (mimeType.startsWith(&quot;video&quot;)) {</span>
<span class="nc" id="L181">			image = THUMBNAIL_VIDEO;</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">		} else if (mimeType.startsWith(&quot;image&quot;)) {</span>
<span class="nc" id="L183">			image = THUMBNAIL_IMAGE;</span>
		} else {
<span class="nc" id="L185">			LOG.error(&quot;Unrecognised mime type [&quot; + mimeType + &quot;]&quot;);</span>
<span class="nc" id="L186">			image = THUMBNAIL_MISC;</span>
		}

		// Check if we need to adjust the provided default thumbnail size
<span class="nc bnc" id="L190" title="All 4 branches missed.">		boolean sameHeight = scale.height == -1 || scale.height == THUMBNAIL_DEFAULT_SIZE.height;</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">		boolean sameWidth = scale.width == -1 || scale.width == THUMBNAIL_DEFAULT_SIZE.width;</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">		if (!sameHeight || !sameWidth) {</span>
			// Scale to correct size
<span class="nc" id="L194">			ByteArrayInputStream byteIs = new ByteArrayInputStream(image.getBytes());</span>
<span class="nc" id="L195">			byte[] bytes = createImageThumbnail(byteIs, scale);</span>
<span class="nc" id="L196">			image = new BytesImage(bytes, &quot;image/jpeg&quot;, &quot;Thumbnail of &quot; + name, null);</span>
		}
<span class="nc" id="L198">		return image;</span>
	}

	/**
	 * This method will create a JPEG &quot;thumb nail&quot; of an image read from an {@link InputStream}. The maximum Dimension
	 * of the returned JPEG Image will be {@link #THUMBNAIL_MAX}.
	 *
	 * @param is the InputStream representing the image for which the JPEG thumb nail is to be returned.
	 * @param scaledSize the size to which the given &lt;em&gt;image&lt;/em&gt; is to be scaled.
	 * @return a byte[] representing the JPEG thumb nail.
	 */
	private static byte[] createImageThumbnail(final InputStream is, final Dimension scaledSize) {
		BufferedImage image;
		MemoryCacheImageInputStream mciis;

		try {
<span class="nc" id="L214">			mciis = new MemoryCacheImageInputStream(is);</span>
<span class="nc" id="L215">			image = ImageIO.read(mciis);</span>
<span class="nc" id="L216">		} catch (Exception e) {</span>
<span class="nc" id="L217">			LOG.warn(&quot;Unable to read input image&quot;, e);</span>
<span class="nc" id="L218">			return null;</span>
<span class="nc" id="L219">		}</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (image == null) {</span>
<span class="nc" id="L222">			return null;</span>
		}

		try {
<span class="nc" id="L226">			byte[] jpeg = createScaledJPEG(image, scaledSize);</span>
<span class="nc" id="L227">			return jpeg;</span>
<span class="nc" id="L228">		} catch (Exception e) {</span>
<span class="nc" id="L229">			LOG.error(&quot;Error creating thumbnail from image&quot;, e);</span>
		} finally {
<span class="nc" id="L231">			image.flush();</span>
<span class="nc" id="L232">		}</span>

<span class="nc" id="L234">		return null;</span>

	}

	/**
	 * This method creates an array of bytes representing a JPEG image that is a &quot;scaled&quot; version of the given
	 * {@link Image}.
	 *
	 * @param image The image to be turned into a scaled JPEG.
	 * @param scaledSize The size to which the given &lt;em&gt;image&lt;/em&gt; is to be scaled.
	 * @return A byte[] representing the JPEG image containing the scaled {@link Image}.
	 * @throws IOException on any sort of error.
	 */
	private static byte[] createScaledJPEG(final Image image, final Dimension scaledSize) throws
			IOException {
		// Scale the image.
<span class="nc" id="L250">		Image scaledImage = image.getScaledInstance(scaledSize.width, scaledSize.height,</span>
				Image.SCALE_SMOOTH);

		// Create a BufferedImage copy of the scaledImage.
<span class="nc" id="L254">		BufferedImage bufferedImage = new BufferedImage(scaledImage.getWidth(null), scaledImage.</span>
<span class="nc" id="L255">				getHeight(null),</span>
				BufferedImage.TYPE_INT_RGB);
<span class="nc" id="L257">		Graphics2D graphics = bufferedImage.createGraphics();</span>
<span class="nc" id="L258">		graphics.drawImage(scaledImage, 0, 0, null);</span>
<span class="nc" id="L259">		scaledImage.flush();</span>
<span class="nc" id="L260">		graphics.dispose();</span>

		// Convert the scaled image to a JPEG byte array.
<span class="nc" id="L263">		ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>

<span class="nc" id="L265">		MemoryCacheImageOutputStream mciis = new MemoryCacheImageOutputStream(baos);</span>
<span class="nc" id="L266">		ImageIO.write(bufferedImage, IMAGE_JPEG_FORMAT, mciis);</span>
<span class="nc" id="L267">		mciis.flush();</span>
<span class="nc" id="L268">		bufferedImage.flush();</span>

<span class="nc" id="L270">		byte[] jpeg = baos.toByteArray();</span>
<span class="nc" id="L271">		mciis.close();</span>

<span class="nc" id="L273">		return jpeg;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>