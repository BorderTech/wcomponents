<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../resources/report.gif" type="image/gif"/><title>DiagnosticImpl.java</title><link rel="stylesheet" href="../../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">WComponents Coverage</a> &gt; <a href="../index.html" class="el_bundle">WComponents</a> &gt; <a href="index.source.html" class="el_package">com.github.bordertech.wcomponents.validation</a> &gt; <span class="el_source">DiagnosticImpl.java</span></div><h1>DiagnosticImpl.java</h1><pre class="source lang-java linenums">package com.github.bordertech.wcomponents.validation;

import com.github.bordertech.wcomponents.Input;
import com.github.bordertech.wcomponents.UIContext;
import com.github.bordertech.wcomponents.UIContextHolder;
import com.github.bordertech.wcomponents.WComponent;
import com.github.bordertech.wcomponents.WText;
import com.github.bordertech.wcomponents.util.I18nUtilities;
import com.github.bordertech.wcomponents.util.Util;
import java.io.Serializable;
import java.text.MessageFormat;

/**
 * Default implementation of the {@link Diagnostic} interface.
 *
 * @see Diagnostic
 *
 * @author James Gifford
 * @since 1.0.0
 */
public class DiagnosticImpl implements Diagnostic {

	/**
	 * The severity of the diagnostic. One of {@link Diagnostic#INFO},
	 * {@link Diagnostic#WARNING} or {@link Diagnostic#ERROR}.
	 */
	private final int severity;

	/**
	 * The UIContext in which the diagnostic occurred.
	 */
	private final UIContext uic;

	/**
	 * The field is the source of the diagnostic, or null if there is no appropriate field. Preferably a {@link Input}.
	 */
	private final WComponent component;

	/**
	 * The message pattern. This must use {@link MessageFormat} syntax if args are present.
	 */
	private final String message;

	/**
	 * The message format arguments.
	 */
	private final Object[] args;

	// --------------------------------------------------------
	// Constructors
	/**
	 * Constructs a DiagnosticImpl.
	 *
	 * @param severity The severity of the diagnostic. One of {@link Diagnostic#INFO}, {@link Diagnostic#WARNING} or
	 * {@link Diagnostic#ERROR}.
	 *
	 * @param source the component which the diagnostic relates to.
	 * @param message the message to display to the user, using {@link MessageFormat} syntax.
	 * @param args optional arguments for the message format string.
	 */
	public DiagnosticImpl(final int severity, final WComponent source,
			final String message, final Serializable... args) {
<span class="fc" id="L63">		this(severity, UIContextHolder.getCurrent(), source, message, args);</span>
<span class="fc" id="L64">	}</span>

	/**
	 * Constructs a DiagnosticImpl (such as an error, warning, or information item) using generic Java Objects as source
	 * and sourceField.
	 *
	 * @param severity The severity of the diagnostic. One of {@link Diagnostic#INFO}, {@link Diagnostic#WARNING} or
	 * {@link Diagnostic#ERROR}.
	 *
	 * @param uic the current user's UIContext
	 * @param source the component which the diagnostic relates to.
	 * @param message the message to display to the user, using {@link MessageFormat} syntax.
	 * @param args optional arguments for the message format string.
	 */
	public DiagnosticImpl(final int severity, final UIContext uic, final WComponent source,
<span class="fc" id="L79">			final String message, final Serializable... args) {</span>
<span class="fc" id="L80">		this.severity = severity;</span>
<span class="fc" id="L81">		this.uic = uic;</span>
<span class="fc" id="L82">		this.component = source;</span>
<span class="fc" id="L83">		this.message = message;</span>
<span class="fc" id="L84">		this.args = args;</span>
<span class="fc" id="L85">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String getDescription() {
		// We need to change references to input fields to their label or accessible text.
<span class="fc" id="L93">		Object[] modifiedArgs = new Object[args.length];</span>

<span class="fc bfc" id="L95" title="All 2 branches covered.">		for (int i = 0; i &lt; args.length; i++) {</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">			if (args[i] instanceof Input) {</span>
<span class="fc" id="L97">				Input input = (Input) args[i];</span>
<span class="fc" id="L98">				String text = null;</span>

<span class="fc" id="L100">				UIContextHolder.pushContext(uic);</span>

				try {
<span class="fc bfc" id="L103" title="All 2 branches covered.">					if (input.getLabel() != null) {</span>
<span class="fc" id="L104">						text = input.getLabel().getText();</span>

						// Some apps use colons at the end of labels. We trim these off automatically
<span class="pc bpc" id="L107" title="1 of 4 branches missed.">						if (!Util.empty(text) &amp;&amp; text.charAt(text.length() - 1) == ':') {</span>
<span class="fc" id="L108">							text = text.substring(0, text.length() - 1);</span>
						}
					}

<span class="fc bfc" id="L112" title="All 2 branches covered.">					if (text == null) {</span>
<span class="fc" id="L113">						text = input.getAccessibleText();</span>
					}
				} finally {
<span class="pc" id="L116">					UIContextHolder.popContext();</span>
<span class="fc" id="L117">				}</span>

<span class="fc bfc" id="L119" title="All 2 branches covered.">				modifiedArgs[i] = text == null ? &quot;&quot; : text;</span>
<span class="fc" id="L120">			} else {</span>
<span class="fc" id="L121">				modifiedArgs[i] = args[i];</span>
			}
		}

<span class="fc" id="L125">		return I18nUtilities.format(null, message, modifiedArgs);</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int getSeverity() {
<span class="fc" id="L133">		return severity;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public UIContext getContext() {
<span class="fc" id="L141">		return uic;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public WComponent getComponent() {
<span class="fc" id="L149">		return component;</span>
	}

	/**
	 * Creates a {@link WComponent} that will render the error message. If users want to do something more sophisticated
	 * than rendering the description as text (e.g. the message might include a link/button) then they should extend
	 * this class and override this method.
	 *
	 * @return The WComponent that represents the error message.
	 */
	public WComponent createDiagnosticErrorComponent() {
<span class="fc" id="L160">		return new WText() {</span>
			@Override
			public String getText() {
<span class="fc" id="L163">				return getDescription();</span>
			}
		};
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>