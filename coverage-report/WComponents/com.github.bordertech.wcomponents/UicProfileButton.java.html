<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../resources/report.gif" type="image/gif"/><title>UicProfileButton.java</title><link rel="stylesheet" href="../../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">WComponents Coverage</a> &gt; <a href="../index.html" class="el_bundle">WComponents</a> &gt; <a href="index.source.html" class="el_package">com.github.bordertech.wcomponents</a> &gt; <span class="el_source">UicProfileButton.java</span></div><h1>UicProfileButton.java</h1><pre class="source lang-java linenums">package com.github.bordertech.wcomponents;

import com.github.bordertech.wcomponents.servlet.WebXmlRenderContext;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

/**
 * This is a convenience WComponent and basically a WButton. When click on it, information about the WComponent tree and
 * UIContext will be displayed after the button.
 *
 * @author Ming Gao
 *
 * @deprecated 1.1.4 This is NOT a core component and will be deleted ASAP.
 */
public class UicProfileButton extends WButton {

	/**
	 * Creates a UicProfileButton.
	 */
	public UicProfileButton() {
<span class="fc" id="L27">		super();</span>
<span class="fc" id="L28">	}</span>

	/**
	 * Creates a UicProfileButton with the given button caption.
	 *
	 * @param caption the button caption.
	 */
	public UicProfileButton(final String caption) {
<span class="fc" id="L36">		super(caption);</span>
<span class="fc" id="L37">	}</span>

	/**
	 * Override afterPaint to paint the profile information if the button has been pressed.
	 *
	 * @param renderContext the renderContext to send output to.
	 */
	@Override
	protected void afterPaint(final RenderContext renderContext) {
<span class="fc" id="L46">		super.afterPaint(renderContext);</span>

<span class="pc bpc" id="L48" title="1 of 4 branches missed.">		if (this.isPressed() &amp;&amp; renderContext instanceof WebXmlRenderContext) {</span>
<span class="fc" id="L49">			PrintWriter writer = ((WebXmlRenderContext) renderContext).getWriter();</span>

<span class="fc" id="L51">			StringBuffer temp = dumpAll();</span>
<span class="fc" id="L52">			writer.println(&quot;&lt;br/&gt;&lt;br/&gt;&quot;);</span>
<span class="fc" id="L53">			writer.println(temp);</span>
		}
<span class="fc" id="L55">	}</span>

	/**
	 * Dumps all the profiling information in textual format to a StringBuffer.
	 *
	 * @return the profiling information in textual format.
	 */
	public StringBuffer dumpAll() {
<span class="fc" id="L63">		WComponent root = WebUtilities.getTop(this);</span>

<span class="fc" id="L65">		Map&lt;String, GroupData&gt; compTallyByClass = new TreeMap&lt;&gt;();</span>

<span class="fc" id="L67">		GroupData compDataOverall = new GroupData();</span>

<span class="fc" id="L69">		StringBuffer out = new StringBuffer();</span>

<span class="fc" id="L71">		String className = root.getClass().getName();</span>

<span class="fc" id="L73">		out.append(&quot;&lt;strong&gt;The root of the WComponent tree is:&lt;/strong&gt;&lt;br/&gt;&quot;).append(className).append(</span>
				&quot;&lt;br/&gt;&quot;);

<span class="fc" id="L76">		tally(root, compTallyByClass, compDataOverall, out);</span>

<span class="fc" id="L78">		out.append(&quot;&lt;strong&gt;WComponent usage overall:&lt;/strong&gt;&lt;br/&gt; &quot;);</span>
<span class="fc" id="L79">		out.append(compDataOverall.total).append(&quot; WComponent(s) in the WComponent tree.&lt;br/&gt;&quot;);</span>

<span class="pc bpc" id="L81" title="1 of 2 branches missed.">		if (compDataOverall.total &gt; 0) {</span>
<span class="fc" id="L82">			out.append(&quot;&lt;strong&gt;WComponent usage by class:&lt;/strong&gt;&lt;br/&gt;&quot;);</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">			for (Map.Entry&lt;String, GroupData&gt; entry : compTallyByClass.entrySet()) {</span>
<span class="fc" id="L85">				className = entry.getKey();</span>
<span class="fc" id="L86">				GroupData dataForClass = entry.getValue();</span>
<span class="fc" id="L87">				out.append(' ').append(dataForClass.total).append(&quot;  &quot;).append(className).append(</span>
						&quot;&lt;br/&gt;&quot;);
<span class="fc" id="L89">			}</span>

<span class="fc" id="L91">			out.append(&quot;&lt;br/&gt;&lt;hr/&gt;&quot;);</span>
		}

<span class="fc" id="L94">		processUic(out);</span>

<span class="fc" id="L96">		return out;</span>
	}

	/**
	 * @param component the component
	 * @param map the group data
	 * @param compDataOverall the overall group data
	 * @param out the buffer
	 */
	private void tally(final WComponent component, final Map&lt;String, GroupData&gt; map,
			final GroupData compDataOverall, final StringBuffer out) {
<span class="fc" id="L107">		String classKey = component.getClass().getName();</span>
<span class="fc" id="L108">		GroupData dataForClass = map.get(classKey);</span>

<span class="pc bpc" id="L110" title="1 of 2 branches missed.">		if (dataForClass == null) {</span>
<span class="fc" id="L111">			dataForClass = new GroupData();</span>
<span class="fc" id="L112">			map.put(classKey, dataForClass);</span>
		}

<span class="fc" id="L115">		dataForClass.total++;</span>
<span class="fc" id="L116">		compDataOverall.total++;</span>

<span class="fc bfc" id="L118" title="All 2 branches covered.">		if (component instanceof Container) {</span>
<span class="fc" id="L119">			int count = ((Container) component).getChildCount();</span>

<span class="fc bfc" id="L121" title="All 2 branches covered.">			for (int i = 0; i &lt; count; i++) {</span>
<span class="fc" id="L122">				WComponent child = ((Container) component).getChildAt(i);</span>
<span class="fc" id="L123">				tally(child, map, compDataOverall, out);</span>
			}
		}
<span class="fc" id="L126">	}</span>

	/**
	 * @param out the current buffer
	 */
	private void processUic(final StringBuffer out) {
<span class="fc" id="L132">		Set components = UIContextHolder.getCurrent().getComponents();</span>

		// Variables that will contain the stats collected.
<span class="fc" id="L135">		GroupData dataOverall = new GroupData();</span>
<span class="fc" id="L136">		Map&lt;String, GroupData&gt; tallyByClass = new TreeMap&lt;&gt;();</span>
<span class="fc" id="L137">		Map&lt;String, ProfileData&gt; profileByClass = new TreeMap&lt;&gt;();</span>
<span class="fc" id="L138">		Set&lt;WComponent&gt; topComponents = new HashSet&lt;&gt;();</span>

<span class="fc" id="L140">		out.append(&quot;\n&lt;strong&gt;UIContext details:\n&lt;/strong&gt;&quot;</span>
				+ &quot;\n&lt;br/&gt;\n&lt;table border=\&quot;1\&quot;&gt;\n&lt;tr&gt;\n&lt;th&gt;Class Name&lt;/th&gt;\n&quot;
				+ &quot;\n&lt;th&gt;ID&lt;/th&gt;\n&quot;
				+ &quot;\n&lt;th&gt;Is Serialisable&lt;/th&gt;\n&quot;
				+ &quot;\n&lt;th&gt;Size&lt;/th&gt;&lt;/tr&gt;\n&quot;);

<span class="fc bfc" id="L146" title="All 2 branches covered.">		for (Iterator iter = components.iterator(); iter.hasNext();) {</span>
<span class="fc" id="L147">			WComponent comp = (WComponent) iter.next();</span>
			// processData(comp);

<span class="fc" id="L150">			String className = comp.getClass().getName();</span>

<span class="fc" id="L152">			ProfileData profileForClass = profileByClass.get(className);</span>

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">			if (!comp.isDefaultState()) {</span>
<span class="fc" id="L155">				ProfileDetailsData profile = new ProfileDetailsData();</span>
<span class="fc" id="L156">				profile.id = comp.getId();</span>

<span class="fc" id="L158">				profile.isSerializable = true;</span>
<span class="fc" id="L159">				profile.size = 0;</span>

<span class="fc" id="L161">				out.append(&quot;\n&lt;tr&gt;\n&lt;td&gt;&quot;);</span>
<span class="fc" id="L162">				out.append(className);</span>
<span class="fc" id="L163">				out.append(&quot;&lt;/td&gt;\n\n&lt;td&gt;&quot;);</span>
<span class="fc" id="L164">				out.append(profile.id);</span>
<span class="fc" id="L165">				out.append(&quot;&lt;/td&gt;\n\n&lt;td&gt;&quot;);</span>
<span class="fc" id="L166">				out.append(profile.isSerializable);</span>
<span class="fc" id="L167">				out.append(&quot;&lt;/td&gt;\n\n&lt;td&gt;&quot;);</span>
<span class="fc" id="L168">				out.append(profile.size);</span>
<span class="fc" id="L169">				out.append(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);</span>

<span class="pc bpc" id="L171" title="1 of 2 branches missed.">				if (profileForClass == null) {</span>
<span class="fc" id="L172">					profileForClass = new ProfileData();</span>
<span class="fc" id="L173">					profileByClass.put(className, profileForClass);</span>
				}

<span class="fc" id="L176">				profileForClass.profiles.add(profile);</span>
			}

<span class="fc" id="L179">			GroupData dataForClass = tallyByClass.get(className);</span>

<span class="pc bpc" id="L181" title="1 of 2 branches missed.">			if (dataForClass == null) {</span>
<span class="fc" id="L182">				dataForClass = new GroupData();</span>
<span class="fc" id="L183">				tallyByClass.put(className, dataForClass);</span>
			}

<span class="fc" id="L186">			dataForClass.total++;</span>
<span class="fc" id="L187">			dataOverall.total++;</span>

<span class="pc bpc" id="L189" title="1 of 2 branches missed.">			if (comp.isDefaultState()) {</span>
<span class="nc" id="L190">				dataForClass.unnecessaryCount++;</span>
<span class="nc" id="L191">				dataOverall.unnecessaryCount++;</span>
			}

<span class="fc" id="L194">			WComponent top = WebUtilities.getTop(comp);</span>
<span class="fc" id="L195">			topComponents.add(top);</span>
<span class="fc" id="L196">		}</span>

<span class="fc" id="L198">		out.append(&quot;\n&lt;/table&gt;\n&lt;br/&gt;&lt;hr/&gt;&quot;</span>
				+ &quot;&lt;strong&gt;WComponent session usage overall:&lt;/strong&gt;\n&lt;br/&gt; &quot;);

<span class="fc" id="L201">		out.append(dataOverall.total).append(&quot; WComponent(s) storing data in the session.\n&lt;br/&gt;&quot;);</span>

<span class="pc bpc" id="L203" title="1 of 2 branches missed.">		if (dataOverall.total &gt; 0) {</span>
<span class="fc" id="L204">			out.append('[')</span>
<span class="fc" id="L205">					.append(dataOverall.unnecessaryCount)</span>
<span class="fc" id="L206">					.append(&quot;] WComponent(s) in default state. WComponents in default state do not need to store data in the session.&lt;br/&gt;&quot;</span>
<span class="fc" id="L207">							+ &quot; Therefore, only &quot;).append(</span>
<span class="fc" id="L208">							dataOverall.total - dataOverall.unnecessaryCount)</span>
<span class="fc" id="L209">					.append(&quot; WComponent(s) actually need(s) to store data in the session.&lt;br/&gt;&quot;);</span>

<span class="fc" id="L211">			out.append(&quot;&lt;strong&gt;WComponent session usage by class:&lt;/strong&gt;&lt;br/&gt;&quot;);</span>

<span class="fc bfc" id="L213" title="All 2 branches covered.">			for (Map.Entry&lt;String, GroupData&gt; entry : tallyByClass.entrySet()) {</span>
<span class="fc" id="L214">				String className = entry.getKey();</span>
<span class="fc" id="L215">				GroupData dataForClass = entry.getValue();</span>

<span class="fc" id="L217">				out.append(' ').append(dataForClass.total).append(&quot; [&quot;).append(</span>
<span class="fc" id="L218">						dataForClass.unnecessaryCount).append(&quot;] &quot;)</span>
<span class="fc" id="L219">						.append(className).append(&quot;&lt;br/&gt;&quot;);</span>
<span class="fc" id="L220">			}</span>

<span class="fc" id="L222">			out.append(&quot;Found &quot;).append(topComponents.size()).append(&quot; top component(s).&lt;br/&gt;&lt;hr/&gt;&quot;);</span>
		}
<span class="fc" id="L224">	}</span>

	/**
	 * Holds statistics for a single WComponent class.
	 *
	 * @author Ming Gao
	 */
<span class="fc" id="L231">	private static final class GroupData {</span>

		/**
		 * The count of instances of the particular WComponent class with a component model in the context/session.
		 */
<span class="fc" id="L236">		private int total = 0;</span>

		/**
		 * The count of instances of the particular WComponent class with a component model in the context/session which
		 * doesn't need to be there.
		 */
<span class="fc" id="L242">		private int unnecessaryCount = 0;</span>
	}

	/**
	 * @author Ming Gao
	 */
<span class="fc" id="L248">	private static final class ProfileDetailsData {</span>

		private int size;

		private String id;

		private boolean isSerializable;
	}

	/**
	 * @author Ming Gao
	 */
<span class="fc" id="L260">	private static final class ProfileData {</span>

<span class="fc" id="L262">		private final List&lt;ProfileDetailsData&gt; profiles = new ArrayList&lt;&gt;();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>