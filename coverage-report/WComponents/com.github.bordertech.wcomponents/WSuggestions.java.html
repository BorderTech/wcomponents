<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../resources/report.gif" type="image/gif"/><title>WSuggestions.java</title><link rel="stylesheet" href="../../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">WComponents Coverage</a> &gt; <a href="../index.html" class="el_bundle">WComponents</a> &gt; <a href="index.source.html" class="el_package">com.github.bordertech.wcomponents</a> &gt; <span class="el_source">WSuggestions.java</span></div><h1>WSuggestions.java</h1><pre class="source lang-java linenums">package com.github.bordertech.wcomponents;

import com.github.bordertech.wcomponents.util.Config;
import com.github.bordertech.wcomponents.util.Factory;
import com.github.bordertech.wcomponents.util.LookupTable;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

/**
 * WSuggestions represents a device for providing suggested input for a text-like input field. The suggestions may be a
 * static list, derived from a data url or acquired on the fly (via AJAX) based on user input into an associated input.
 * &lt;p&gt;
 * WSuggestions has no effect unless it is associated with a text-like input control such as WTextField. If it is
 * associated with a constrained input (such as WEmailField) then it is expected (but not enforced) that the suggestions
 * would be in line with the associated field's constraints.
 * &lt;/p&gt;
 * &lt;p&gt;
 * It allows for client caching of frequently used lists via a data key or lists that can be produced via AJAX depending
 * on the text entered in the related TextField.
 * &lt;/p&gt;
 * &lt;p&gt;
 * Suggestions provided via a lookup table are cached on the client and filtered on the client.
 * &lt;/p&gt;
 * &lt;p&gt;
 * To have a suggestion list dynamically updated via AJAX, do not use a lookup table, but manually set the options and
 * set a refresh action via {@link #setRefreshAction(Action)}. The text entered by the user that triggered the refresh
 * is provided by {@link #getAjaxFilter()}.
 * &lt;/p&gt;
 *
 * @author Jonathan Austin
 * @since 1.0.0
 */
public class WSuggestions extends AbstractWComponent implements AjaxInternalTrigger, AjaxTarget {

	/**
	 * The Application-wide lookup-table to use.
	 */
<span class="fc" id="L39">	private static final LookupTable APPLICATION_LOOKUP_TABLE = Factory.newInstance(</span>
			LookupTable.class);

	/**
	 * AJAX refresh command.
	 */
	public static final String AJAX_REFRESH_ACTION_COMMAND = &quot;Refresh&quot;;

	/**
	 * The way in which the suggestion is provided to and selected by the user. Defaults to BOTH and should remain as
	 * this for combobox implementations. LIST should be used for implementations which enforce selection of an existing
	 * value. We may want to consider INLINE in the future but I see no reason for NONE since then it would not be a
	 * combo.
	 */
<span class="pc" id="L53">	public enum Autocomplete {</span>
		/**
		 * Indicates that autocomplete may be from the textbox or from the suggestion list.
		 */
<span class="fc" id="L57">		BOTH,</span>
		/**
		 * Indicates the autocomplete must only be from the suggestion list.
		 */
<span class="fc" id="L61">		LIST</span>
	};

	/**
	 * Create a WSuggestions.
	 */
	public WSuggestions() {
<span class="fc" id="L68">		super();</span>
<span class="fc" id="L69">	}</span>

	/**
	 * Creates a WSuggestions with predefined suggestions.
	 *
	 * @param suggestions the list of suggestions.
	 */
<span class="fc" id="L76">	public WSuggestions(final List&lt;String&gt; suggestions) {</span>
<span class="fc" id="L77">		getComponentModel().setSuggestions(suggestions);</span>
<span class="fc" id="L78">	}</span>

	/**
	 * Creates a WSuggestions using a lookup table for the suggestions.
	 *
	 * @param lookupTable the lookup table identifier to obtain the list of suggestions.
	 */
<span class="fc" id="L85">	public WSuggestions(final Object lookupTable) {</span>
<span class="fc" id="L86">		getComponentModel().setLookupTable(lookupTable);</span>
<span class="fc" id="L87">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void handleRequest(final Request request) {
		// Check if this suggestion list is the current AJAX trigger
<span class="fc bfc" id="L95" title="All 2 branches covered.">		if (AjaxHelper.isCurrentAjaxTrigger(this)) {</span>
<span class="fc" id="L96">			String filter = request.getParameter(getId());</span>
<span class="fc" id="L97">			setAjaxFilter(filter);</span>
<span class="fc" id="L98">			doHandleAjaxRefresh();</span>
		}
<span class="fc" id="L100">	}</span>

	/**
	 * Handle the AJAX refresh request.
	 */
	protected void doHandleAjaxRefresh() {
<span class="fc" id="L106">		final Action action = getRefreshAction();</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">		if (action == null) {</span>
<span class="nc" id="L108">			return;</span>
		}

<span class="fc" id="L111">		final ActionEvent event = new ActionEvent(this, AJAX_REFRESH_ACTION_COMMAND, getAjaxFilter());</span>
<span class="fc" id="L112">		Runnable later = new Runnable() {</span>
			@Override
			public void run() {
<span class="fc" id="L115">				action.execute(event);</span>
<span class="fc" id="L116">			}</span>
		};

<span class="fc" id="L119">		invokeLater(later);</span>
<span class="fc" id="L120">	}</span>

	/**
	 * Returns the complete list of suggestions available for selection for this user's session.
	 *
	 * @return the list of suggestions available for the given user's session.
	 */
	public List&lt;String&gt; getSuggestions() {
		// Lookup table
<span class="fc" id="L129">		Object table = getLookupTable();</span>

<span class="fc bfc" id="L131" title="All 2 branches covered.">		if (table == null) {</span>
<span class="fc" id="L132">			SuggestionsModel model = getComponentModel();</span>
<span class="fc" id="L133">			List&lt;String&gt; suggestions = model.getSuggestions();</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">			return suggestions == null ? Collections.EMPTY_LIST : suggestions;</span>
		} else {
<span class="fc" id="L136">			List&lt;?&gt; lookupSuggestions = APPLICATION_LOOKUP_TABLE.getTable(table);</span>
<span class="pc bpc" id="L137" title="2 of 4 branches missed.">			if (lookupSuggestions == null || lookupSuggestions.isEmpty()) {</span>
<span class="nc" id="L138">				return Collections.EMPTY_LIST;</span>
			}
			// Build list of String suggestions
<span class="fc" id="L141">			List&lt;String&gt; suggestions = new ArrayList&lt;&gt;(lookupSuggestions.size());</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">			for (Object suggestion : lookupSuggestions) {</span>
<span class="fc" id="L143">				String sugg = APPLICATION_LOOKUP_TABLE.getDescription(table, suggestion);</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">				if (sugg != null) {</span>
<span class="fc" id="L145">					suggestions.add(sugg);</span>
				}
<span class="fc" id="L147">			}</span>
<span class="fc" id="L148">			return Collections.unmodifiableList(suggestions);</span>
		}
	}

	/**
	 * Retrieves the data list cache key for this component.
	 *
	 * @return the cache key if client-side caching is enabled, null otherwise.
	 */
	public String getListCacheKey() {
<span class="fc" id="L158">		Object table = getLookupTable();</span>

<span class="pc bpc" id="L160" title="1 of 4 branches missed.">		if (table != null &amp;&amp; Config.getInstance().getBoolean(</span>
				AbstractWSelectList.DATALIST_CACHING_PARAM_KEY, false)) {
<span class="fc" id="L162">			String key = APPLICATION_LOOKUP_TABLE.getCacheKeyForTable(table);</span>
<span class="fc" id="L163">			return key;</span>
		}

<span class="fc" id="L166">		return null;</span>
	}

	/**
	 * Set the complete list of suggestions available for selection for this user's session.
	 *
	 * @param suggestions the list of suggestions available to the user.
	 */
	public void setSuggestions(final List&lt;String&gt; suggestions) {
<span class="fc" id="L175">		SuggestionsModel model = getOrCreateComponentModel();</span>
<span class="fc" id="L176">		model.setSuggestions(suggestions);</span>
<span class="fc" id="L177">	}</span>

	/**
	 * Set the lookupTable for this user's session.
	 *
	 * @param lookupTable the lookup table identifier to obtain the suggestions for the list.
	 */
	public void setLookupTable(final Object lookupTable) {
<span class="fc" id="L185">		getOrCreateComponentModel().setLookupTable(lookupTable);</span>
<span class="fc" id="L186">	}</span>

	/**
	 * Get the lookupTable for this user's session.
	 *
	 * @return the lookupTable for the suggestions
	 */
	public Object getLookupTable() {
<span class="fc" id="L194">		return getComponentModel().getLookupTable();</span>
	}

	/**
	 * @param action the refresh action. Ignored if using a lookup table.
	 */
	public void setRefreshAction(final Action action) {
<span class="fc" id="L201">		getOrCreateComponentModel().action = action;</span>
<span class="fc" id="L202">	}</span>

	/**
	 * @return the refresh action. Ignored if using a lookup table.
	 */
	public Action getRefreshAction() {
<span class="fc" id="L208">		return getComponentModel().action;</span>
	}

	/**
	 * @param filter the refresh filter value passed on the AJAX request.
	 */
	protected void setAjaxFilter(final String filter) {
<span class="fc" id="L215">		getOrCreateComponentModel().filter = filter;</span>
<span class="fc" id="L216">	}</span>

	/**
	 * @return the refresh filter value passed on the AJAX request. Ignored if using a lookup table.
	 */
	public String getAjaxFilter() {
<span class="fc" id="L222">		return getComponentModel().filter;</span>
	}

	/**
	 * @param autocomplete The Autocomplete to set for this instance.
	 */
	public void setAutocomplete(final Autocomplete autocomplete) {
<span class="fc" id="L229">		getOrCreateComponentModel().autocomplete = autocomplete;</span>
<span class="fc" id="L230">	}</span>

	/**
	 * @return The autocomplete for this instance.
	 */
	public Autocomplete getAutocomplete() {
<span class="fc" id="L236">		return getComponentModel().autocomplete;</span>
	}

	/**
	 * The minimum number of characters entered before refreshing suggestions. A value of zero indicates to use the
	 * theme default, which is usually 3.
	 *
	 * @param min the minimum number of characters entered before refreshing suggestions.
	 */
	public void setMinRefresh(final int min) {
<span class="fc bfc" id="L246" title="All 2 branches covered.">		if (min &lt; 0) {</span>
<span class="fc" id="L247">			throw new IllegalArgumentException(</span>
					&quot;Minimum refresh value cannot be less than 0. Where zero indicates use the default value.&quot;);
		}
<span class="fc" id="L250">		getOrCreateComponentModel().min = min;</span>
<span class="fc" id="L251">	}</span>

	/**
	 * The minimum characters entered before triggering the refresh action.
	 * &lt;p&gt;
	 * A value of zero indicates the theme default will be used (usually 3).
	 * &lt;/p&gt;
	 *
	 * @return the minimum characters entered before triggering the refresh action.
	 */
	public int getMinRefresh() {
<span class="fc" id="L262">		return getComponentModel().min;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	// For type safety only
	protected SuggestionsModel getComponentModel() {
<span class="fc" id="L271">		return (SuggestionsModel) super.getComponentModel();</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	// For type safety only
	protected SuggestionsModel getOrCreateComponentModel() {
<span class="fc" id="L280">		return (SuggestionsModel) super.getOrCreateComponentModel();</span>
	}

	/**
	 * Creates a new component model appropriate for this component.
	 *
	 * @return a new PanelModel.
	 */
	@Override
	protected SuggestionsModel newComponentModel() {
<span class="fc" id="L290">		return new SuggestionsModel();</span>
	}

	/**
	 * A class used to hold the list of options for this component.
	 */
<span class="fc" id="L296">	public static class SuggestionsModel extends ComponentModel {</span>

		/**
		 * The suggestions for this list.
		 */
		private List&lt;String&gt; suggestions;

		/**
		 * The name of the lookup table which will be used to obtain the list of suggestions.
		 */
		private Object lookupTable;

		/**
		 * Minimum characters entered before refresh suggestions. Zero means use theme default.
		 */
<span class="fc" id="L311">		private int min = 0;</span>

		/**
		 * Action when refresh requested via AJAX.
		 */
		private Action action;

		/**
		 * Filter value passed on the AJAX request.
		 */
		private String filter;

		/**
		 * @return returns the suggestions.
		 */
		private List&lt;String&gt; getSuggestions() {
<span class="fc" id="L327">			return suggestions;</span>
		}

		/**
		 * The autocomplete model for the suggestions.
		 */
<span class="fc" id="L333">		private Autocomplete autocomplete = Autocomplete.BOTH;</span>

		/**
		 * @param suggestions the suggestions to set.
		 */
		private void setSuggestions(final List&lt;String&gt; suggestions) {
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">			this.suggestions = suggestions == null ? null : Collections.</span>
<span class="fc" id="L340">					unmodifiableList(suggestions);</span>
<span class="fc" id="L341">			lookupTable = null;</span>
<span class="fc" id="L342">		}</span>

		/**
		 * @param lookupTable the lookup table name to set.
		 */
		private void setLookupTable(final Object lookupTable) {
<span class="fc" id="L348">			this.lookupTable = lookupTable;</span>
<span class="fc" id="L349">			suggestions = null;</span>
<span class="fc" id="L350">		}</span>

		/**
		 * @return the lookupTable.
		 */
		private Object getLookupTable() {
<span class="fc" id="L356">			return lookupTable;</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>