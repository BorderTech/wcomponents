<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../resources/report.gif" type="image/gif"/><title>DebugValidateXML.java</title><link rel="stylesheet" href="../../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">WComponents Coverage</a> &gt; <a href="../index.html" class="el_bundle">WComponents</a> &gt; <a href="index.source.html" class="el_package">com.github.bordertech.wcomponents</a> &gt; <span class="el_source">DebugValidateXML.java</span></div><h1>DebugValidateXML.java</h1><pre class="source lang-java linenums">package com.github.bordertech.wcomponents;

import com.github.bordertech.wcomponents.container.ValidateXMLInterceptor;
import com.github.bordertech.wcomponents.util.DebugUtil;
import com.github.bordertech.wcomponents.util.XMLUtil;
import java.io.StringReader;
import javax.xml.XMLConstants;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;
import org.xml.sax.helpers.DefaultHandler;

/**
 * A class used to make sure the HTML/XML generated by each {@link WComponent} is well formed. {@link DebugUtil} is used
 * to determine if XML Validation is enabled. As each WComponent paints its output, and if XML validation is enabled,
 * WComponent calls this class to verify the HTML/XML. If a WComponent has badly formed HTML/XML, then an error message,
 * along with the component details are stored in a framework attribute to be retrieved later by the
 * {@link ValidateXMLInterceptor} so they can be reported in the response HTML.
 *
 * @author Jonathan Austin
 * @since 1.0.0
 */
public final class DebugValidateXML {

	/**
	 * The logger instance for this class.
	 */
<span class="fc" id="L32">	private static final Log LOG = LogFactory.getLog(DebugValidateXML.class);</span>

	/**
	 * Hide the constructor as there are no instance methods.
	 */
<span class="nc" id="L37">	private DebugValidateXML() {</span>
<span class="nc" id="L38">	}</span>

	/**
	 * Check if Validate XML is enabled.
	 *
	 * @return true or false
	 */
	public static boolean isEnabled() {
<span class="fc" id="L46">		return DebugUtil.isValidateXMLEnabled();</span>
	}

	/**
	 * Validate the component to make sure the generated XML is schema compliant.
	 *
	 * @param xml the xml to validate
	 * @return Any errors found, or null if the XML is valid.
	 */
	public static String validateXMLAgainstSchema(final String xml) {
		// Validate XML against schema
<span class="pc bpc" id="L57" title="2 of 4 branches missed.">		if (xml != null &amp;&amp; !xml.equals(&quot;&quot;)) {</span>
			// Wrap XML with a root element (if required)
<span class="fc" id="L59">			String testXML = wrapXMLInRootElement(xml);</span>
			try {
				// Create SAX Parser Factory
<span class="fc" id="L62">				SAXParserFactory spf = SAXParserFactory.newInstance();</span>
<span class="fc" id="L63">				spf.setNamespaceAware(true);</span>
<span class="fc" id="L64">				spf.setValidating(true);</span>

				// Create SAX Parser
<span class="fc" id="L67">				SAXParser parser = spf.newSAXParser();</span>
<span class="fc" id="L68">				parser.setProperty(&quot;http://java.sun.com/xml/jaxp/properties/schemaLanguage&quot;,</span>
						XMLConstants.W3C_XML_SCHEMA_NS_URI);

				// Set schema location
<span class="fc" id="L72">				Object schema = DebugValidateXML.class.getResource(getSchemaPath()).toString();</span>
<span class="fc" id="L73">				parser.setProperty(&quot;http://java.sun.com/xml/jaxp/properties/schemaSource&quot;, schema);</span>

				// Setup the handler to throw an exception when an error occurs
<span class="fc" id="L76">				DefaultHandler handler = new DefaultHandler() {</span>
					@Override
					public void warning(final SAXParseException e) throws SAXException {
<span class="nc" id="L79">						LOG.warn(&quot;XML Schema warning: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L80">						super.warning(e);</span>
<span class="nc" id="L81">					}</span>

					@Override
					public void fatalError(final SAXParseException e) throws SAXException {
<span class="fc" id="L85">						throw e;</span>
					}

					@Override
					public void error(final SAXParseException e) throws SAXException {
<span class="fc" id="L90">						throw e;</span>
					}
				};

				// Validate the XML
<span class="fc" id="L95">				InputSource xmlSource = new InputSource(new StringReader(testXML));</span>
<span class="fc" id="L96">				parser.parse(xmlSource, handler);</span>

<span class="fc" id="L98">			} catch (SAXParseException e) {</span>
<span class="fc" id="L99">				return &quot;At line &quot; + e.getLineNumber() + &quot;, column: &quot; + e.getColumnNumber()</span>
<span class="fc" id="L100">						+ &quot; ==&gt; &quot; + e.getMessage();</span>
<span class="nc" id="L101">			} catch (Exception e) {</span>
<span class="nc" id="L102">				return e.getMessage();</span>
<span class="fc" id="L103">			}</span>
		}

<span class="fc" id="L106">		return null;</span>
	}

	/**
	 * Wrap the XML in a root element before validating.
	 *
	 * @param xml the XML to wrap
	 * @return the XML wrapped in a root element
	 */
	public static String wrapXMLInRootElement(final String xml) {
		// The XML may not need to be wrapped.
<span class="fc bfc" id="L117" title="All 4 branches covered.">		if (xml.startsWith(&quot;&lt;?xml&quot;) || xml.startsWith(&quot;&lt;!DOCTYPE&quot;)) {</span>
<span class="fc" id="L118">			return xml;</span>
		} else {
			// ENTITY definition required for NBSP.
			// ui namepsace required for xml theme.
<span class="fc" id="L122">			return XMLUtil.XML_DECLERATION_WITH_DOC_TYPE + &quot;&lt;ui:root&quot; + XMLUtil.STANDARD_NAMESPACES + &quot;&gt;&quot; + xml</span>
					+ &quot;&lt;/ui:root&gt;&quot;;
		}
	}

	/**
	 * Return the path to the schema to test against. This can be overridden if client applications wish to validate
	 * their own components.
	 *
	 * @return the schema path for the current theme in use.
	 */
	protected static String getSchemaPath() {
<span class="fc" id="L134">		return &quot;/schema/ui/v1/schema.xsd&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>