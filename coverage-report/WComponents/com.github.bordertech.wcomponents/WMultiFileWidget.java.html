<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../resources/report.gif" type="image/gif"/><title>WMultiFileWidget.java</title><link rel="stylesheet" href="../../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">WComponents Coverage</a> &gt; <a href="../index.html" class="el_bundle">WComponents</a> &gt; <a href="index.source.html" class="el_package">com.github.bordertech.wcomponents</a> &gt; <span class="el_source">WMultiFileWidget.java</span></div><h1>WMultiFileWidget.java</h1><pre class="source lang-java linenums">package com.github.bordertech.wcomponents;

import com.github.bordertech.wcomponents.WLink.ImagePosition;
import com.github.bordertech.wcomponents.file.File;
import com.github.bordertech.wcomponents.file.FileItemWrap;
import com.github.bordertech.wcomponents.render.webxml.FileWidgetRendererUtil;
import com.github.bordertech.wcomponents.util.SystemException;
import com.github.bordertech.wcomponents.util.Util;
import com.github.bordertech.wcomponents.util.XMLUtil;
import com.github.bordertech.wcomponents.util.thumbnail.ThumbnailUtil;
import java.awt.Dimension;
import java.io.Serializable;
import java.io.StringWriter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;
import org.apache.commons.fileupload.FileItem;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * &lt;p&gt;
 * The WMultiFileWidget component allows multiple file input elements to be uploaded, without requiring an entire page
 * reload for each item. After a file is uploaded to the server the client displays the file information with a checkbox
 * adjacent to it. The file information is a link that pops up the file content. Use {@link #getFiles()} to retrieve all
 * files uploaded by the client, use {@link #getSelectedFiles()} to retrieve only the selected file items.
 * &lt;/p&gt;
 * &lt;p&gt;
 * The maximum number of allowed files, maximum individual file size, and allowed file types can be configured.
 * &lt;/p&gt;
 *
 * @author Christina Harris
 * @author Jonathan Austin
 * @author Rick Brown
 * @since 1.0.0
 */
<span class="fc" id="L43">public class WMultiFileWidget extends AbstractInput implements Targetable, AjaxTrigger, AjaxTarget,</span>
		SubordinateTarget {

	/**
	 * The logger instance for this class.
	 */
<span class="fc" id="L49">	private static final Log LOG = LogFactory.getLog(WMultiFileWidget.class);</span>

	/**
	 * File upload index content request.
	 */
	public static final String FILE_UPLOAD_ID_KEY = &quot;wc_fileid&quot;;

	/**
	 * File upload index thumb nail content request.
	 */
	public static final String FILE_UPLOAD_THUMB_NAIL_KEY = &quot;wc_filetn&quot;;

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String getValueAsString() {
<span class="fc" id="L66">		List&lt;FileWidgetUpload&gt; files = getValue();</span>

<span class="pc bpc" id="L68" title="1 of 4 branches missed.">		if ((files == null) || files.isEmpty()) {</span>
<span class="fc" id="L69">			return null;</span>
		}

<span class="fc" id="L72">		StringBuffer stringValues = new StringBuffer();</span>

<span class="fc" id="L74">		boolean append = false;</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">		for (FileWidgetUpload file : files) {</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">			if (append) {</span>
<span class="fc" id="L77">				stringValues.append(&quot;, &quot;);</span>
			}
<span class="fc" id="L79">			stringValues.append(file.getFile().toString());</span>
<span class="fc" id="L80">			append = true;</span>
<span class="fc" id="L81">		}</span>

<span class="fc" id="L83">		return stringValues.toString();</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List&lt;FileWidgetUpload&gt; getValue() {
<span class="fc" id="L91">		List&lt;FileWidgetUpload&gt; files = (List&lt;FileWidgetUpload&gt;) getData();</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">		if (files == null) {</span>
<span class="fc" id="L94">			return Collections.emptyList();</span>
		} else {
<span class="fc" id="L96">			return Collections.unmodifiableList(files);</span>
		}
	}

	/**
	 * Gets all the File items that have been uploaded.
	 *
	 * @return A list of all File items uploaded by the client.
	 */
	public List&lt;FileWidgetUpload&gt; getFiles() {
<span class="fc" id="L106">		return getValue();</span>
	}

	/**
	 * Add a file item to this widget.
	 *
	 * @param file the file item
	 */
	public void addFile(final FileWidgetUpload file) {
<span class="nc" id="L115">		List&lt;FileWidgetUpload&gt; files = (List&lt;FileWidgetUpload&gt;) getData();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">		if (files == null) {</span>
<span class="nc" id="L117">			files = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L118">			setData(files);</span>
		}
<span class="nc" id="L120">		files.add(file);</span>
<span class="nc" id="L121">	}</span>

	/**
	 * Remove the file.
	 *
	 * @param file the file to remove
	 */
	public void removeFile(final FileWidgetUpload file) {
<span class="nc" id="L129">		List&lt;FileWidgetUpload&gt; files = (List&lt;FileWidgetUpload&gt;) getData();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">		if (files != null) {</span>
<span class="nc" id="L131">			files.remove(file);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (files.isEmpty()) {</span>
<span class="nc" id="L133">				setData(null);</span>
			}
		}
<span class="nc" id="L136">	}</span>

	/**
	 * Retrieves the File at the given index. Will throw an {@link IndexOutOfBoundsException} if &lt;code&gt;index&lt;/code&gt; is
	 * not in the range of the list of items.
	 *
	 * @param fileId the file id
	 * @return The FileWidgetUpload for the file id or null
	 */
	public FileWidgetUpload getFile(final String fileId) {
<span class="fc bfc" id="L146" title="All 2 branches covered.">		for (FileWidgetUpload file : getFiles()) {</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">			if (Util.equals(file.getFileId(), fileId)) {</span>
<span class="fc" id="L148">				return file;</span>
			}
<span class="fc" id="L150">		}</span>
<span class="fc" id="L151">		return null;</span>
	}

	/**
	 * Returns only the selected file items. The file is selected if the checkbox adjacent to the uploaded file name is
	 * checked by the user.
	 *
	 * @return The uploaded file items that have been selected by the user. If no files have been selected then an empty
	 * list is returned.
	 * @deprecated no longer required as unselected files are now removed. So all files are &quot;selected&quot;.
	 */
	@Deprecated
	public List&lt;FileWidgetUpload&gt; getSelectedFiles() {
<span class="nc" id="L164">		return getValue();</span>
	}

	/**
	 * Indicates whether the given upload has been selected by the user.
	 *
	 * @param upload the uploaded file
	 * @return true if the upload has been selected, false otherwise.
	 * @deprecated no longer required as unselected files are now removed. So all files are &quot;selected&quot;.
	 */
	@Deprecated
	public boolean isSelected(final File upload) {
<span class="nc" id="L176">		return true;</span>
	}

	/**
	 * Clear uploaded files from this component.
	 */
	public void clearFiles() {
<span class="fc" id="L183">		resetData();</span>
<span class="fc" id="L184">	}</span>

	/**
	 * Set each file type to be accepted by the WMultiFileWidget.
	 *
	 * @see #setFileTypes(java.util.Collection) for the file types
	 *
	 * @param types The file types that will be accepted by the file input.
	 */
	public void setFileTypes(final String[] types) {
<span class="fc bfc" id="L194" title="All 2 branches covered.">		if (types == null) {</span>
<span class="fc" id="L195">			setFileTypes((List&lt;String&gt;) null);</span>
		} else {
<span class="fc" id="L197">			setFileTypes(Arrays.asList(types));</span>
		}
<span class="fc" id="L199">	}</span>

	/**
	 * Determines the file types accepted by this widget. Note that duplicates are not allowed and these are not case
	 * sensitive. A file type may be one of the following:
	 * &lt;ul&gt;
	 * &lt;li&gt;The string audio/* (Indicates that sound files are accepted.)&lt;/li&gt;
	 * &lt;li&gt;The string video/* (Indicates that video files are accepted.)&lt;/li&gt;
	 * &lt;li&gt;The string image/* (Indicates that image files are accepted.)&lt;/li&gt;
	 * &lt;li&gt;A valid MIME type with no parameters (Indicates that files of the specified type are accepted.)&lt;/li&gt;
	 * &lt;li&gt;A string whose first character is a &quot;.&quot; (U+002E) character (Indicates that files with the specified file
	 * extension are accepted).&lt;/li&gt;
	 * &lt;/ul&gt;
	 *
	 * @param types The file types that will be accepted by the file input. Note that this is not additive, it will
	 * overwrite any previously set fileTypes. Pass null or and empty collection to clear all file types.
	 */
	public void setFileTypes(final Collection&lt;String&gt; types) {
<span class="fc" id="L217">		Set newFileTypes = null;</span>
<span class="fc" id="L218">		MultiFileWidgetModel model = getOrCreateComponentModel();</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">		if (types != null) {</span>
<span class="fc" id="L220">			newFileTypes = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">			for (String fileType : types) {</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">				if (fileType != null) {</span>
<span class="fc" id="L223">					String uniqueFileType = fileType.toLowerCase();  // Lowercase to avoid duplication</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">					if (isValid(uniqueFileType)) {</span>
<span class="fc" id="L225">						newFileTypes.add(uniqueFileType);</span>
					} else {
<span class="fc" id="L227">						throw new IllegalArgumentException(&quot;Not a valid filetype: &quot; + fileType);</span>
					}
				}
<span class="fc" id="L230">			}</span>
		}
<span class="fc" id="L232">		model.fileTypes = newFileTypes;</span>
<span class="fc" id="L233">	}</span>

	/**
	 * Check that the file type SEEMS to be legit.
	 *
	 * @param fileType The file type to check
	 * @return true if the file type is valid.
	 */
	private boolean isValid(final String fileType) {
<span class="fc" id="L242">		boolean result = false;</span>
<span class="pc bpc" id="L243" title="2 of 4 branches missed.">		if (fileType != null &amp;&amp; fileType.length() &gt; 1) { // the shortest I can think of would be something like &quot;.h&quot;</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">			if (fileType.startsWith(&quot;.&quot;)) { // assume it's a file extension</span>
<span class="fc" id="L245">				result = true;</span>
<span class="pc bpc" id="L246" title="1 of 4 branches missed.">			} else if (fileType.length() &gt; 2 &amp;&amp; fileType.indexOf('/') &gt; 0) { // some imaginary mimetype like &quot;a/*&quot; would be at least 3 characters</span>
<span class="fc" id="L247">				result = true;</span>
			}
		}
<span class="fc" id="L250">		return result;</span>
	}

	/**
	 * Returns a list of file types accepted by the file input.
	 *
	 * @see #setFileTypes(Collection) for a description of what constitutes an allowable file types
	 *
	 * If no types have been added an empty list is returned. An empty list indicates that all file types are accepted.
	 *
	 * @return The file types accepted by this file input e.g. &quot;image/*&quot;, &quot;.vis&quot;, &quot;text/plain&quot;, &quot;text/html&quot;,
	 * &quot;application/pdf&quot;.
	 */
	public List&lt;String&gt; getFileTypes() {
<span class="fc" id="L264">		Set&lt;String&gt; fileTypes = getComponentModel().fileTypes;</span>
		List&lt;String&gt; result;
<span class="fc bfc" id="L266" title="All 4 branches covered.">		if (fileTypes == null || fileTypes.isEmpty()) {</span>
<span class="fc" id="L267">			return Collections.emptyList();</span>
		}
<span class="fc" id="L269">		result = new ArrayList&lt;&gt;(fileTypes);</span>
<span class="fc" id="L270">		return result;</span>
	}

	/**
	 * Set the maximum file size (in bytes) that will be accepted by the file input. If the user selects a file larger
	 * than this value the client script will tell the user it cannot be uploaded.
	 *
	 * @param bytes The maximum size (in bytes) that can be uploaded by this input.
	 */
	public void setMaxFileSize(final long bytes) {
<span class="fc" id="L280">		getOrCreateComponentModel().maxFileSize = bytes;</span>
<span class="fc" id="L281">	}</span>

	/**
	 * Return the maximum file size (in bytes) that can be accepted by this file input.
	 *
	 * @return The maximum size (in bytes) that can be uploaded by this component.
	 */
	public long getMaxFileSize() {
<span class="fc" id="L289">		return getComponentModel().maxFileSize;</span>
	}

	/**
	 * Return the maximum number of files that can be accepted by this file input.
	 *
	 * @return The maximum number of files that can be uploaded by this component.
	 */
	public int getMaxFiles() {
<span class="fc" id="L298">		return getComponentModel().maxFiles;</span>
	}

	/**
	 * Set the maximum number of files that will be accepted by the file input.
	 *
	 * @param maxFiles The maximum number of files that can be uploaded by this input.
	 */
	public void setMaxFiles(final int maxFiles) {
<span class="fc" id="L307">		getOrCreateComponentModel().maxFiles = maxFiles;</span>
<span class="fc" id="L308">	}</span>

	/**
	 * Register a component to receive drag and dropped files on behalf of this input. It is recommended that you
	 * register the WApplication as the dropzone. This allows users to drop files anywhere on the page and eliminates
	 * the risk of them dropping files outside of the dropzone (which causes the browser to attempt to render the
	 * dropped files).
	 *
	 * @param dropzone The dropzone.
	 */
	public void setDropzone(final DropZone dropzone) {
<span class="nc" id="L319">		getOrCreateComponentModel().dropzone = dropzone;</span>
<span class="nc" id="L320">	}</span>

	/**
	 * Return the dropzone associated with this file input.
	 *
	 * @return The dropzone or null if not set.
	 */
	public DropZone getDropzone() {
<span class="fc" id="L328">		return getComponentModel().dropzone;</span>
	}

	/**
	 * The AJAX action used when an uploaded file has been selected.
	 * &lt;p&gt;
	 * Setting this action causes the uploaded file links to act as AJAX triggers. The file id of the selected file is
	 * set as the action object.
	 * &lt;/p&gt;
	 *
	 * @param action the file AJAX action
	 */
	public void setFileAjaxAction(final Action action) {
<span class="nc" id="L341">		getOrCreateComponentModel().fileAction = action;</span>
<span class="nc" id="L342">	}</span>

	/**
	 * The AJAX action used when an uploaded file has been selected.
	 *
	 * @return the file AJAX action
	 */
	public Action getFileAjaxAction() {
<span class="fc" id="L350">		return getComponentModel().fileAction;</span>
	}

	/**
	 * Sets the layout of uploaded files to be a certain number of columns. Null uses the theme default.
	 *
	 * @param cols the number of columns.
	 */
	public void setColumns(final Integer cols) {
<span class="nc bnc" id="L359" title="All 4 branches missed.">		if (cols != null &amp;&amp; cols &lt; 0) {</span>
<span class="nc" id="L360">			throw new IllegalArgumentException(&quot;Must have zero or more columns&quot;);</span>
		}
<span class="nc" id="L362">		getOrCreateComponentModel().cols = cols;</span>
<span class="nc" id="L363">	}</span>

	/**
	 * @return the number of columns for layout of uploaded files. Null uses the theme default.
	 */
	public Integer getColumns() {
<span class="fc" id="L369">		return getComponentModel().cols;</span>
	}

	/**
	 * Used in handle request processing to trigger on change processing.
	 *
	 * @return true if a new file has been uploaded
	 */
	protected boolean isNewUpload() {
<span class="nc" id="L378">		return getComponentModel().newUpload;</span>
	}

	/**
	 * @param newUpload true if a new file has been uploaded
	 */
	public void setNewUpload(final boolean newUpload) {
<span class="nc" id="L385">		getOrCreateComponentModel().newUpload = newUpload;</span>
<span class="nc" id="L386">	}</span>

	/**
	 * @return true if generate thumb nails for the file links.
	 */
	public boolean isUseThumbnails() {
<span class="fc" id="L392">		return getComponentModel().useThumbnails;</span>
	}

	/**
	 * If enabled then uploaded files will display to the user as thumbnails. While this can be used for any file types
	 * it is only recommended when the WMultiFileWidget is set to accept image types only, e.g. with
	 * &lt;code&gt;setFileTypes(new String[] { &quot;image/*&quot; });&lt;/code&gt;
	 *
	 * @param useThumbnails true if generate thumb nails for the file links.
	 */
	public void setUseThumbnails(final boolean useThumbnails) {
<span class="nc" id="L403">		getOrCreateComponentModel().useThumbnails = useThumbnails;</span>
<span class="nc" id="L404">	}</span>

	/**
	 * @return the position of the thumbnail image on the file link
	 */
	public ImagePosition getThumbnailPosition() {
<span class="nc" id="L410">		return getComponentModel().thumbnailPosition;</span>
	}

	/**
	 * The position of the thumbnail image on the file link.
	 * &lt;p&gt;
	 * If no position is set then the text is not shown.
	 * &lt;/p&gt;
	 *
	 * @param thumbnailPosition the position of the image
	 */
	public void setThumbnailPosition(final ImagePosition thumbnailPosition) {
<span class="nc" id="L422">		getOrCreateComponentModel().thumbnailPosition = thumbnailPosition;</span>
<span class="nc" id="L423">	}</span>

	/**
	 * Retrieve the thumbnail size. If null, the default size is used.
	 *
	 * @return the thumbnail size or null for default
	 */
	public Dimension getThumbnailSize() {
<span class="nc" id="L431">		return getComponentModel().thumbnailSize;</span>
	}

	/**
	 * Set the thumbnail size. Null uses the default size.
	 * &lt;p&gt;
	 * To scale thumbnails to a certain height or width, use -1 on the scalable dimension. For example, to scale
	 * thumbnails to 64 pixels high but maintain the correct width ration, set Height to 64 and Width to -1.
	 * &lt;/p&gt;
	 *
	 * @param thumbnailSize the thumbnail size or null for default
	 */
	public void setThumbnailSize(final Dimension thumbnailSize) {
<span class="nc bnc" id="L444" title="All 2 branches missed.">		if (thumbnailSize != null) {</span>
<span class="nc bnc" id="L445" title="All 4 branches missed.">			if (thumbnailSize.height == 0 || thumbnailSize.width == 0) {</span>
<span class="nc" id="L446">				throw new IllegalArgumentException(</span>
						&quot;Thumbnail size cannot have a height or width of zero.&quot;);
			}
<span class="nc bnc" id="L449" title="All 4 branches missed.">			if (thumbnailSize.height == -1 &amp;&amp; thumbnailSize.width == -1) {</span>
<span class="nc" id="L450">				throw new IllegalArgumentException(</span>
						&quot;Thumbnail size cannot have both height and width set to -1.&quot;);
			}
		}
<span class="nc" id="L454">		getOrCreateComponentModel().thumbnailSize = thumbnailSize;</span>
<span class="nc" id="L455">	}</span>

	/**
	 * Clear the thumbnails currently set on the files. This will cause them to be generated again when requested. This
	 * can be used if the thumbanil size has changed.
	 */
	public void clearThumbnails() {
<span class="nc bnc" id="L462" title="All 2 branches missed.">		for (FileWidgetUpload file : getFiles()) {</span>
<span class="nc" id="L463">			file.setThumbnail(null);</span>
<span class="nc" id="L464">		}</span>
<span class="nc" id="L465">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected boolean doHandleRequest(final Request request) {
		// This is a normal page request.
<span class="nc" id="L473">		List&lt;FileWidgetUpload&gt; newSelections = getNewSelection(request);</span>
<span class="nc" id="L474">		List&lt;FileWidgetUpload&gt; priorSelections = getValue();</span>

<span class="nc bnc" id="L476" title="All 2 branches missed.">		boolean changed = !selectionsEqual(newSelections, priorSelections);</span>

<span class="nc bnc" id="L478" title="All 2 branches missed.">		if (changed) {</span>
<span class="nc" id="L479">			setData(newSelections);</span>
		}

		// Check for new uploads
<span class="nc bnc" id="L483" title="All 2 branches missed.">		if (isNewUpload()) {</span>
<span class="nc" id="L484">			changed = true;</span>
<span class="nc" id="L485">			setNewUpload(false);</span>
		}

<span class="nc" id="L488">		return changed;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List&lt;FileWidgetUpload&gt; getRequestValue(final Request request) {
<span class="nc bnc" id="L496" title="All 2 branches missed.">		if (isPresent(request)) {</span>
<span class="nc" id="L497">			return getNewSelection(request);</span>
		} else {
<span class="nc" id="L499">			return getValue();</span>
		}
	}

	/**
	 * Register the widget for AJAX.
	 *
	 * @param request the request being responded to.
	 */
	@Override
	protected void preparePaintComponent(final Request request) {
<span class="fc" id="L510">		super.preparePaintComponent(request);</span>
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">		if (getFileAjaxAction() != null) {</span>
<span class="nc" id="L512">			AjaxHelper.registerComponentTargetItself(getId(), request);</span>
		}
<span class="fc" id="L514">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected boolean beforeHandleRequest(final Request request) {
		// Check if is targeted request
<span class="nc" id="L522">		String targetParam = request.getParameter(Environment.TARGET_ID);</span>
<span class="nc bnc" id="L523" title="All 4 branches missed.">		boolean targetted = (targetParam != null &amp;&amp; targetParam.equals(getTargetId()));</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">		if (targetted) {</span>
<span class="nc" id="L525">			doHandleTargetedRequest(request);</span>
<span class="nc" id="L526">			return false;</span>
		}

		// Check if AJAX trigger and has file id in request
<span class="nc bnc" id="L530" title="All 4 branches missed.">		if (AjaxHelper.isCurrentAjaxTrigger(this) &amp;&amp; request.getParameter(FILE_UPLOAD_ID_KEY) != null) {</span>
<span class="nc" id="L531">			doHandleFileAjaxActionRequest(request);</span>
<span class="nc" id="L532">			return false;</span>
		}

<span class="nc" id="L535">		return true;</span>
	}

	/**
	 * Handle a file action AJAX request.
	 *
	 * @param request the request being processed
	 */
	protected void doHandleFileAjaxActionRequest(final Request request) {
		// Protect against client-side tampering of disabled components
<span class="nc bnc" id="L545" title="All 2 branches missed.">		if (isDisabled()) {</span>
<span class="nc" id="L546">			throw new SystemException(&quot;File widget is disabled.&quot;);</span>
		}

		// Check for file id
<span class="nc" id="L550">		String fileId = request.getParameter(FILE_UPLOAD_ID_KEY);</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">		if (fileId == null) {</span>
<span class="nc" id="L552">			throw new SystemException(&quot;No file id provided for ajax action.&quot;);</span>
		}

		// Check valid file id
<span class="nc" id="L556">		FileWidgetUpload file = getFile(fileId);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">		if (file == null) {</span>
<span class="nc" id="L558">			throw new SystemException(&quot;Invalid file id [&quot; + fileId + &quot;].&quot;);</span>
		}

		// Run the action
<span class="nc" id="L562">		final Action action = getFileAjaxAction();</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">		if (action == null) {</span>
<span class="nc" id="L564">			throw new SystemException(&quot;No action set for file ajax action request.&quot;);</span>
		}

		// Set the selected file id as the action object
<span class="nc" id="L568">		final ActionEvent event = new ActionEvent(this, &quot;fileajax&quot;, fileId);</span>
<span class="nc" id="L569">		Runnable later = new Runnable() {</span>
			@Override
			public void run() {
<span class="nc" id="L572">				action.execute(event);</span>
<span class="nc" id="L573">			}</span>
		};

<span class="nc" id="L576">		invokeLater(later);</span>
<span class="nc" id="L577">	}</span>

	/**
	 * Handle a targeted request.
	 *
	 * @param request the request being processed
	 */
	protected void doHandleTargetedRequest(final Request request) {
		// Upload file request
<span class="nc bnc" id="L586" title="All 2 branches missed.">		if (request.getFileItems(getId()) != null) {</span>
<span class="nc" id="L587">			doHandleUploadRequest(request);</span>
<span class="nc" id="L588">			return;</span>
		}

		// Check for file id
<span class="nc" id="L592">		String fileId = request.getParameter(FILE_UPLOAD_ID_KEY);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">		if (fileId == null) {</span>
<span class="nc" id="L594">			throw new SystemException(&quot;No file id provided for content request.&quot;);</span>
		}

		// Check valid file id
<span class="nc" id="L598">		FileWidgetUpload file = getFile(fileId);</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">		if (file == null) {</span>
<span class="nc" id="L600">			throw new SystemException(&quot;Invalid file id [&quot; + fileId + &quot;].&quot;);</span>
		}

		// Check if thumb nail requested
<span class="nc bnc" id="L604" title="All 2 branches missed.">		boolean thumbNail = request.getParameter(FILE_UPLOAD_THUMB_NAIL_KEY) != null;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">		if (thumbNail) {</span>
<span class="nc" id="L606">			doHandleThumbnailRequest(file);</span>
		} else {
<span class="nc" id="L608">			doHandleFileContentRequest(file);</span>
		}
<span class="nc" id="L610">	}</span>

	/**
	 * The request is a targeted file upload request. Upload the file and respond with the file information.
	 *
	 * @param request the request being processed.
	 */
	protected void doHandleUploadRequest(final Request request) {
		// Protect against client-side tampering of disabled/read-only fields.
<span class="nc bnc" id="L619" title="All 4 branches missed.">		if (isDisabled() || isReadOnly()) {</span>
<span class="nc" id="L620">			throw new SystemException(&quot;File widget cannot be updated.&quot;);</span>
		}

		// Only process on a POST
<span class="nc bnc" id="L624" title="All 2 branches missed.">		if (!&quot;POST&quot;.equals(request.getMethod())) {</span>
<span class="nc" id="L625">			throw new SystemException(</span>
<span class="nc" id="L626">					&quot;File widget cannot be updated by &quot; + request.getMethod() + &quot;.&quot;);</span>
		}

		// Check only one file item in the request
<span class="nc" id="L630">		FileItem[] items = request.getFileItems(getId());</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">		if (items.length &gt; 1) {</span>
<span class="nc" id="L632">			throw new SystemException(&quot;More than one file item received on the request.&quot;);</span>
		}

		// Check the client provided a fileID
<span class="nc" id="L636">		String fileId = request.getParameter(FILE_UPLOAD_ID_KEY);</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">		if (fileId == null) {</span>
<span class="nc" id="L638">			throw new SystemException(&quot;No file id provided for file upload.&quot;);</span>
		}

		// Wrap the file item
<span class="nc" id="L642">		FileItemWrap wrap = new FileItemWrap(items[0]);</span>
<span class="nc" id="L643">		FileWidgetUpload file = new FileWidgetUpload(fileId, wrap);</span>
<span class="nc" id="L644">		addFile(file);</span>

<span class="nc" id="L646">		int idx = getFiles().size() - 1;</span>

<span class="nc" id="L648">		setNewUpload(true);</span>

		// Build response
<span class="nc" id="L651">		StringWriter writer = new StringWriter();</span>
<span class="nc" id="L652">		XmlStringBuilder xml = new XmlStringBuilder(writer);</span>

<span class="nc" id="L654">		UIContext uic = UIContextHolder.getCurrent();</span>

<span class="nc" id="L656">		xml.append(XMLUtil.getXMLDeclarationWithThemeXslt(uic));</span>

<span class="nc" id="L658">		xml.appendTagOpen(&quot;ui:ajaxResponse&quot;);</span>
<span class="nc" id="L659">		xml.append(XMLUtil.STANDARD_NAMESPACES);</span>
<span class="nc" id="L660">		xml.appendClose();</span>
<span class="nc" id="L661">		xml.appendTagOpen(&quot;ui:ajaxTarget&quot;);</span>
<span class="nc" id="L662">		xml.appendAttribute(&quot;id&quot;, getId());</span>
<span class="nc" id="L663">		xml.appendAttribute(&quot;action&quot;, &quot;replace&quot;);</span>
<span class="nc" id="L664">		xml.appendClose();</span>

<span class="nc" id="L666">		FileWidgetRendererUtil.renderFileElement(this, xml, file, idx);</span>

<span class="nc" id="L668">		xml.appendEndTag(&quot;ui:ajaxTarget&quot;);</span>
<span class="nc" id="L669">		xml.appendEndTag(&quot;ui:ajaxResponse&quot;);</span>

<span class="nc" id="L671">		FileUploadXMLResponse content = new FileUploadXMLResponse(writer.getBuffer().toString());</span>
<span class="nc" id="L672">		ContentEscape escape = new ContentEscape(content);</span>
<span class="nc" id="L673">		throw escape;</span>
	}

	/**
	 * Handle the thumb nail request.
	 *
	 * @param file the file to process
	 */
	protected void doHandleThumbnailRequest(final FileWidgetUpload file) {
		// Create thumb nail (if required)
<span class="nc bnc" id="L683" title="All 2 branches missed.">		if (file.getThumbnail() == null) {</span>
<span class="nc" id="L684">			Image thumbnail = createThumbNail(file.getFile());</span>
<span class="nc" id="L685">			file.setThumbnail(thumbnail);</span>
		}
<span class="nc" id="L687">		ContentEscape escape = new ContentEscape(file.getThumbnail());</span>
<span class="nc" id="L688">		throw escape;</span>
	}

	/**
	 * Handle the file content request.
	 *
	 * @param file the file to process
	 */
	protected void doHandleFileContentRequest(final FileWidgetUpload file) {
<span class="nc" id="L697">		ContentEscape escape = new ContentEscape(file.getFile());</span>
<span class="nc" id="L698">		throw escape;</span>
	}

	/**
	 * @param file the file to create a thumbnail for
	 * @return the thumbnail
	 */
	protected Image createThumbNail(final File file) {
<span class="nc" id="L706">		Image image = null;</span>
		try {
<span class="nc" id="L708">			Dimension size = getThumbnailSize();</span>
<span class="nc" id="L709">			image = ThumbnailUtil.createThumbnail(file.getInputStream(), file.getName(), size, file.</span>
<span class="nc" id="L710">					getMimeType());</span>
<span class="nc" id="L711">		} catch (Exception e) {</span>
<span class="nc" id="L712">			LOG.error(&quot;Could not generate thumbnail for file. &quot; + e.getMessage(), e);</span>
<span class="nc" id="L713">		}</span>
<span class="nc" id="L714">		return image;</span>
	}

	/**
	 * Retrieves a URL for the uploaded file content.
	 *
	 * @param fileId the file id
	 * @return the URL to access the uploaded file.
	 */
	public String getFileUrl(final String fileId) {
<span class="fc" id="L724">		FileWidgetUpload file = getFile(fileId);</span>
<span class="pc bpc" id="L725" title="1 of 2 branches missed.">		if (file == null) {</span>
<span class="nc" id="L726">			return null;</span>
		}

<span class="fc" id="L729">		Environment env = getEnvironment();</span>
<span class="fc" id="L730">		Map&lt;String, String&gt; parameters = env.getHiddenParameters();</span>
<span class="fc" id="L731">		parameters.put(Environment.TARGET_ID, getTargetId());</span>

<span class="pc bpc" id="L733" title="1 of 2 branches missed.">		if (Util.empty(file.getFileCacheKey())) {</span>
			// Add some randomness to the URL to prevent caching
<span class="fc" id="L735">			String random = WebUtilities.generateRandom();</span>
<span class="fc" id="L736">			parameters.put(Environment.UNIQUE_RANDOM_PARAM, random);</span>
<span class="fc" id="L737">		} else {</span>
			// Remove step counter as not required for cached content
<span class="nc" id="L739">			parameters.remove(Environment.STEP_VARIABLE);</span>
<span class="nc" id="L740">			parameters.remove(Environment.SESSION_TOKEN_VARIABLE);</span>
			// Add the cache key
<span class="nc" id="L742">			parameters.put(Environment.CONTENT_CACHE_KEY, file.getFileCacheKey());</span>
		}

		// File id
<span class="fc" id="L746">		parameters.put(FILE_UPLOAD_ID_KEY, fileId);</span>

		// The targetable path needs to be configured for the portal environment.
<span class="fc" id="L749">		String url = env.getWServletPath();</span>

		// Note the last parameter. In javascript we don't want to encode &quot;&amp;&quot;.
<span class="fc" id="L752">		return WebUtilities.getPath(url, parameters, true);</span>
	}

	/**
	 * Retrieves a URL for the thumbnail of an uploaded file.
	 *
	 * @param fileId the file id
	 * @return the URL to access the thumbnail for an uploaded file.
	 */
	public String getFileThumbnailUrl(final String fileId) {
<span class="nc" id="L762">		FileWidgetUpload file = getFile(fileId);</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">		if (file == null) {</span>
<span class="nc" id="L764">			return null;</span>
		}

		// Check static resource
<span class="nc" id="L768">		Image thumbnail = file.getThumbnail();</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">		if (thumbnail instanceof InternalResource) {</span>
<span class="nc" id="L770">			return ((InternalResource) thumbnail).getTargetUrl();</span>
		}

<span class="nc" id="L773">		Environment env = getEnvironment();</span>
<span class="nc" id="L774">		Map&lt;String, String&gt; parameters = env.getHiddenParameters();</span>
<span class="nc" id="L775">		parameters.put(Environment.TARGET_ID, getTargetId());</span>

<span class="nc bnc" id="L777" title="All 2 branches missed.">		if (Util.empty(file.getThumbnailCacheKey())) {</span>
			// Add some randomness to the URL to prevent caching
<span class="nc" id="L779">			String random = WebUtilities.generateRandom();</span>
<span class="nc" id="L780">			parameters.put(Environment.UNIQUE_RANDOM_PARAM, random);</span>
<span class="nc" id="L781">		} else {</span>
			// Remove step counter as not required for cached content
<span class="nc" id="L783">			parameters.remove(Environment.STEP_VARIABLE);</span>
<span class="nc" id="L784">			parameters.remove(Environment.SESSION_TOKEN_VARIABLE);</span>
			// Add the cache key
<span class="nc" id="L786">			parameters.put(Environment.CONTENT_CACHE_KEY, file.getThumbnailCacheKey());</span>
		}

		// File id
<span class="nc" id="L790">		parameters.put(FILE_UPLOAD_ID_KEY, fileId);</span>

		// Thumbnail flag
<span class="nc" id="L793">		parameters.put(FILE_UPLOAD_THUMB_NAIL_KEY, &quot;Y&quot;);</span>

		// The targetable path needs to be configured for the portal environment.
<span class="nc" id="L796">		String url = env.getWServletPath();</span>

		// Note the last parameter. In javascript we don't want to encode &quot;&amp;&quot;.
<span class="nc" id="L799">		return WebUtilities.getPath(url, parameters, true);</span>
	}

	/**
	 * @param request the request to process
	 * @return the list of file selections
	 */
	private List&lt;FileWidgetUpload&gt; getNewSelection(final Request request) {
		// Get selected items (if any)
<span class="nc" id="L808">		String[] selectedParam = request.getParameterValues(getId() + &quot;.selected&quot;);</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">		if (selectedParam == null) {</span>
<span class="nc" id="L810">			selectedParam = new String[0];</span>
		}
<span class="nc" id="L812">		List&lt;String&gt; selected = Arrays.asList(selectedParam);</span>

<span class="nc" id="L814">		List&lt;FileWidgetUpload&gt; newSelection = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L815">		List&lt;FileWidgetUpload&gt; currentSelection = getValue();</span>

<span class="nc bnc" id="L817" title="All 2 branches missed.">		for (FileWidgetUpload file : currentSelection) {</span>
<span class="nc" id="L818">			boolean select = selected.contains(file.getFileId());</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">			if (select) {</span>
<span class="nc" id="L820">				newSelection.add(file);</span>
			}
<span class="nc" id="L822">		}</span>

<span class="nc" id="L824">		return newSelection;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String getTargetId() {
<span class="fc" id="L832">		return getId();</span>
	}

	/**
	 * Selection lists are considered equal if they have the same items (order is not important). An empty list is
	 * considered equal to a null list.
	 *
	 * @param list1 the first list to check.
	 * @param list2 the second list to check.
	 * @return true if the lists are equal, false otherwise.
	 */
	private boolean selectionsEqual(final List&lt;?&gt; list1, final List&lt;?&gt; list2) {
<span class="nc bnc" id="L844" title="All 12 branches missed.">		return (list1 == null || list1.isEmpty()) &amp;&amp; (list2 == null || list2.isEmpty())</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">				|| (list1 != null &amp;&amp; list2 != null &amp;&amp; list1.size() == list2.size() &amp;&amp; list1.</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">				containsAll(list2));</span>
	}

	// ----------------------------------------------------------------
	// Extrinsic state management
	// ----------------------------------------------------------------
	/**
	 * @return a new {@link MultiFileWidgetModel}.
	 */
	@Override
	protected MultiFileWidgetModel newComponentModel() {
<span class="fc" id="L857">		return new MultiFileWidgetModel();</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	// For type safety only
	protected MultiFileWidgetModel getComponentModel() {
<span class="fc" id="L866">		return (MultiFileWidgetModel) super.getComponentModel();</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	// For type safety only
	protected MultiFileWidgetModel getOrCreateComponentModel() {
<span class="fc" id="L875">		return (MultiFileWidgetModel) super.getOrCreateComponentModel();</span>
	}

	/**
	 * Holds the extrinsic state information of a WMultiFileWidget.
	 *
	 * @author Christina Harris
	 */
<span class="fc" id="L883">	public static class MultiFileWidgetModel extends InputModel {</span>

		/**
		 * The file types accepted by the file input.
		 */
		private Set&lt;String&gt; fileTypes;

		/**
		 * The maximum size of files uploaded by this component. Defaults to 10Mb.
		 */
<span class="fc" id="L893">		private long maxFileSize = 10 * 1000 * 1024;</span>

		/**
		 * The maximum number of files which can be uploaded by this component.
		 */
		private int maxFiles;

		/**
		 * The component that will receive drag and dropped files on behalf of this widget.
		 */
		private DropZone dropzone;

		/**
		 * File ajax action.
		 */
		private Action fileAction;

		/**
		 * Cols to display uploaded files.
		 */
		private Integer cols;

		/**
		 * Flag if thumbnails should be generated for file links.
		 */
		private boolean useThumbnails;

		/**
		 * Thumnbnail size.
		 */
		private Dimension thumbnailSize;

		/**
		 * Thumbnail position.
		 */
		private ImagePosition thumbnailPosition;

		/**
		 * Uploaded file.
		 */
		private boolean newUpload;
	}

	/**
	 * File upload response. Used to send the response when a file has been uploaded successfully.
	 */
	public static class FileUploadXMLResponse implements ContentAccess {

		/**
		 * Default id.
		 */
		private static final long serialVersionUID = 1L;

		/**
		 * XML response.
		 */
		private final String xml;

		/**
		 * @param xml the xml response
		 */
<span class="nc" id="L954">		public FileUploadXMLResponse(final String xml) {</span>
<span class="nc" id="L955">			this.xml = xml;</span>
<span class="nc" id="L956">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public byte[] getBytes() {
<span class="nc" id="L963">			return xml.getBytes();</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String getDescription() {
<span class="nc" id="L971">			return &quot;fileui&quot;;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String getMimeType() {
<span class="nc" id="L979">			return WebUtilities.CONTENT_TYPE_XML;</span>
		}
	}

	/**
	 * Holds the uploaded file and extra details.
	 */
<span class="fc" id="L986">	public static class FileWidgetUpload implements Serializable {</span>

		/**
		 * File identifier.
		 */
		private final String fileId;

		/**
		 * The file content.
		 */
		private final File file;

		/**
		 * Thumbnail image.
		 */
		private Image thumbnail;

		/**
		 * File cache key.
		 */
		private String fileCacheKey;

		/**
		 * Thumbnail cache key.
		 */
		private String thumbnailCacheKey;

		/**
		 * Creates a FileWidgetUpload.
		 *
		 * @param file the file to hold
		 */
		public FileWidgetUpload(final File file) {
<span class="nc" id="L1019">			this(null, file);</span>
<span class="nc" id="L1020">		}</span>

		/**
		 * Creates a FileWidgetUpload.
		 *
		 * @param id the file id
		 * @param file the file to hold
		 */
<span class="fc" id="L1028">		public FileWidgetUpload(final String id, final File file) {</span>
<span class="pc bpc" id="L1029" title="1 of 2 branches missed.">			if (id == null) {</span>
<span class="nc" id="L1030">				this.fileId = UUID.randomUUID().toString();</span>
			} else {
<span class="fc" id="L1032">				this.fileId = id;</span>
			}
<span class="fc" id="L1034">			this.file = file;</span>
<span class="fc" id="L1035">		}</span>

		/**
		 * @return the file identifier
		 */
		public String getFileId() {
<span class="fc" id="L1041">			return fileId;</span>

		}

		/**
		 * @return the file
		 */
		public File getFile() {
<span class="fc" id="L1049">			return file;</span>
		}

		/**
		 * @param thumbnail the files thumbnail
		 */
		public void setThumbnail(final Image thumbnail) {
<span class="nc" id="L1056">			this.thumbnail = thumbnail;</span>
<span class="nc" id="L1057">		}</span>

		/**
		 * @return the files thumbnail, or null
		 */
		public Image getThumbnail() {
<span class="nc" id="L1063">			return thumbnail;</span>
		}

		/**
		 * Retrieves the cache key for this file.
		 *
		 * @return the cacheKey
		 */
		public String getFileCacheKey() {
<span class="fc" id="L1072">			return fileCacheKey;</span>
		}

		/**
		 * A cache key is used to enable the caching of files on the client agent.
		 *
		 * @param cacheKey the cacheKey to set.
		 */
		public void setFileCacheKey(final String cacheKey) {
<span class="nc" id="L1081">			this.fileCacheKey = cacheKey;</span>
<span class="nc" id="L1082">		}</span>

		/**
		 * Retrieves the cache key for the thumbnail.
		 *
		 * @return the cacheKey
		 */
		public String getThumbnailCacheKey() {
<span class="nc" id="L1090">			return thumbnailCacheKey;</span>
		}

		/**
		 * A cache key is used to enable the caching of the thumbnail on the client agent.
		 *
		 * @param cacheKey the cacheKey to set.
		 */
		public void setThumbnailCacheKey(final String cacheKey) {
<span class="nc" id="L1099">			this.thumbnailCacheKey = cacheKey;</span>
<span class="nc" id="L1100">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public boolean equals(final Object o) {
<span class="pc bpc" id="L1107" title="2 of 4 branches missed.">			return (o instanceof FileWidgetUpload) &amp;&amp; Util.equals(fileId, ((FileWidgetUpload) o).</span>
<span class="fc" id="L1108">					getFileId());</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public int hashCode() {
<span class="nc" id="L1116">			return fileId.hashCode();</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>