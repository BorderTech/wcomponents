<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../resources/report.gif" type="image/gif"/><title>WImage.java</title><link rel="stylesheet" href="../../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">WComponents Coverage</a> &gt; <a href="../index.html" class="el_bundle">WComponents</a> &gt; <a href="index.source.html" class="el_package">com.github.bordertech.wcomponents</a> &gt; <span class="el_source">WImage.java</span></div><h1>WImage.java</h1><pre class="source lang-java linenums">package com.github.bordertech.wcomponents;

import com.github.bordertech.wcomponents.util.Util;
import java.awt.Dimension;
import java.util.Map;

/**
 * &lt;p&gt;
 * The WImage component provides a way for applications to display images within their application. It may either serve
 * up a pre-defined image which is part of the application, or generate the image dynamically.
 * &lt;/p&gt;
 *
 * &lt;pre&gt;
 * // Example of using a pre-defined image included in the applications class-path
 * new WImage(&amp;quot;/com/mycompany/myapp/somePackage/logo.png&amp;quot;, &amp;quot;Application logo&amp;quot;);
 * &lt;/pre&gt;
 *
 * &lt;pre&gt;
 * // Example of using a dynamic image
 * WImage image = new WImage();
 * image.setImage(new com.github.bordertech.wcomponents.Image()
 * {
 *     public Dimension getSize()
 *     {
 *         // Both width and height are unknown
 *         return new Dimension(-1, -1);
 *     }
 *
 *     public String getString()
 *     {
 *         return &amp;quot;Include a relevant description of the image here&amp;quot;;
 *     }
 *
 *     public String getMimeType()
 *     {
 *         // e.g. if serving up a PNG image
 *         return &amp;quot;image/png&amp;quot;;
 *     }
 *
 *     public byte[] getBytes()
 *     {
 *         // read in or create the image binary data here.
 *     }
 * });
 * &lt;/pre&gt;
 *
 * @author Kishan Bisht
 * @since 1.0.0
 */
public class WImage extends WBeanComponent implements Targetable, AjaxTarget {

	/**
	 * Creates a WImage with no content.
	 */
<span class="fc" id="L55">	public WImage() {</span>
<span class="fc" id="L56">	}</span>

	/**
	 * &lt;p&gt;
	 * Creates a WImage with the given static content. This is provided as a convenience method for when the image is
	 * included as static content in the class path rather than in the web application's resources.
	 * &lt;/p&gt;
	 * &lt;p&gt;
	 * The mime type for the image is looked up from the &quot;mimeType.*&quot; mapping configuration parameters using the
	 * resource's file extension.
	 * &lt;/p&gt;
	 *
	 * @param imageResource the resource path to the image file.
	 * @param description the image description.
	 */
	public WImage(final String imageResource, final String description) {
<span class="fc" id="L72">		this(new ImageResource(imageResource, description));</span>
<span class="fc" id="L73">	}</span>

	/**
	 * Creates a WImage with the given image resource.
	 *
	 * @param image the image resource
	 */
<span class="fc" id="L80">	public WImage(final ImageResource image) {</span>
<span class="fc" id="L81">		setImage(image);</span>
<span class="fc" id="L82">	}</span>

	/**
	 * Creates a dynamic URL that the image can be loaded from. In fact the URL points to the main application servlet,
	 * but includes a non-null for the parameter associated with this WComponent (ie, its label). The handleRequest
	 * method below detects this when the browser requests the image
	 *
	 * @return the url to load the image from
	 */
	public String getTargetUrl() {
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">		if (getImageUrl() != null) {</span>
<span class="nc" id="L93">			return getImageUrl();</span>
		}

<span class="fc" id="L96">		Image image = getImage();</span>

<span class="fc bfc" id="L98" title="All 2 branches covered.">		if (image instanceof InternalResource) {</span>
<span class="fc" id="L99">			return ((InternalResource) image).getTargetUrl();</span>
		}

<span class="fc" id="L102">		Environment env = getEnvironment();</span>
<span class="fc" id="L103">		Map&lt;String, String&gt; parameters = env.getHiddenParameters();</span>
<span class="fc" id="L104">		parameters.put(Environment.TARGET_ID, getTargetId());</span>

<span class="pc bpc" id="L106" title="1 of 2 branches missed.">		if (Util.empty(getCacheKey())) {</span>
			// Add some randomness to the URL to prevent caching
<span class="fc" id="L108">			String random = WebUtilities.generateRandom();</span>
<span class="fc" id="L109">			parameters.put(Environment.UNIQUE_RANDOM_PARAM, random);</span>
<span class="fc" id="L110">		} else {</span>
			// Remove step counter as not required for cached content
<span class="nc" id="L112">			parameters.remove(Environment.STEP_VARIABLE);</span>
<span class="nc" id="L113">			parameters.remove(Environment.SESSION_TOKEN_VARIABLE);</span>
			// Add the cache key
<span class="nc" id="L115">			parameters.put(Environment.CONTENT_CACHE_KEY, getCacheKey());</span>
		}

		// this variable needs to be set in the portlet environment.
<span class="fc" id="L119">		String url = env.getWServletPath();</span>

<span class="fc" id="L121">		return WebUtilities.getPath(url, parameters, true);</span>
	}

	/**
	 * When an img element is included in the html output of a page, the browser will make a second request to get the
	 * image contents. The handleRequest method has been overridden to detect whether the request is the &quot;image content
	 * fetch&quot; request by looking for the parameter that we encode in the image url.
	 *
	 * @param request the request being responded to.
	 */
	@Override
	public void handleRequest(final Request request) {
<span class="fc" id="L133">		super.handleRequest(request);</span>

<span class="fc" id="L135">		String targ = request.getParameter(Environment.TARGET_ID);</span>
<span class="pc bpc" id="L136" title="1 of 4 branches missed.">		boolean contentReqested = (targ != null &amp;&amp; targ.equals(getTargetId()));</span>

<span class="fc bfc" id="L138" title="All 2 branches covered.">		if (contentReqested) {</span>
<span class="fc" id="L139">			ContentEscape escape = new ContentEscape(getImage());</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">			escape.setCacheable(!Util.empty(getCacheKey()));</span>
<span class="fc" id="L141">			throw escape;</span>
		}
<span class="fc" id="L143">	}</span>

	/**
	 * Sets the image.
	 *
	 * @param image the image to set.
	 */
	public void setImage(final Image image) {
<span class="fc" id="L151">		ImageModel model = getOrCreateComponentModel();</span>
<span class="fc" id="L152">		model.image = image;</span>
<span class="fc" id="L153">		model.imageUrl = null;</span>
<span class="fc" id="L154">	}</span>

	/**
	 * Sets the image to an external URL.
	 *
	 * @param imageUrl the image URL.
	 */
	public void setImageUrl(final String imageUrl) {
<span class="nc" id="L162">		ImageModel model = getOrCreateComponentModel();</span>
<span class="nc" id="L163">		model.imageUrl = imageUrl;</span>
<span class="nc" id="L164">		model.image = null;</span>
<span class="nc" id="L165">	}</span>

	/**
	 * @return the image to an external URL.
	 */
	public String getImageUrl() {
<span class="fc" id="L171">		return getComponentModel().imageUrl;</span>
	}

	/**
	 * Retrieves the current image.
	 *
	 * @return the current image.
	 */
	public Image getImage() {
<span class="fc" id="L180">		return getComponentModel().image;</span>
	}

	/**
	 * Retrieves the cache key for this image. This is used to enable caching of the image on the client agent.
	 *
	 * @return the cacheKey
	 */
	public String getCacheKey() {
<span class="fc" id="L189">		return getComponentModel().cacheKey;</span>
	}

	/**
	 * A cache key is used to enable the caching of images on the client agent.
	 * &lt;p&gt;
	 * The cache key should be unique for each image.
	 * &lt;/p&gt;
	 *
	 * @param cacheKey the cacheKey to set.
	 */
	public void setCacheKey(final String cacheKey) {
<span class="fc" id="L201">		getOrCreateComponentModel().cacheKey = cacheKey;</span>
<span class="fc" id="L202">	}</span>

	/**
	 * Retrieve the image size.
	 * &lt;p&gt;
	 * Returns the size set via {@link #setSize(Dimension)}. If this has not been set and an image resource is
	 * provideing the image then the size of the image resource is returned. Otherwise return null.
	 * &lt;/p&gt;
	 *
	 * @return the size of the image.
	 */
	public Dimension getSize() {
<span class="fc" id="L214">		Dimension size = getComponentModel().size;</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">		if (size != null) {</span>
<span class="nc" id="L216">			return size;</span>
		}
<span class="fc" id="L218">		Image image = getImage();</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">		if (image != null) {</span>
<span class="fc" id="L220">			return image.getSize();</span>
		}
<span class="nc" id="L222">		return null;</span>
	}

	/**
	 * @param size the size of the image.
	 */
	public void setSize(final Dimension size) {
<span class="nc" id="L229">		getOrCreateComponentModel().size = size;</span>
<span class="nc" id="L230">	}</span>

	/**
	 * Retrieve the alternative text for the image.
	 * &lt;p&gt;
	 * Returns the alternative text set via {@link #setAlternativeText(String)}. If this has not been set and an image
	 * resource is providing the image then the description of the image resource is returned. Otherwise return null.
	 * &lt;/p&gt;
	 *
	 * @return the alternative text for the image.
	 */
	public String getAlternativeText() {
<span class="fc" id="L242">		String text = getComponentModel().alternativeText;</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">		if (text != null) {</span>
<span class="nc" id="L244">			return text;</span>
		}
<span class="fc" id="L246">		Image image = getImage();</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">		if (image != null) {</span>
<span class="fc" id="L248">			return image.getDescription();</span>
		}
<span class="nc" id="L250">		return null;</span>
	}

	/**
	 * @param text the alternative text for the image
	 */
	public void setAlternativeText(final String text) {
<span class="nc" id="L257">		getOrCreateComponentModel().alternativeText = text;</span>
<span class="nc" id="L258">	}</span>

	/**
	 * Returns the id to use to target this component.
	 *
	 * @return this component's target id.
	 */
	@Override
	public String getTargetId() {
<span class="fc" id="L267">		return getId();</span>
	}

	/**
	 * @return a String representation of this component, for debugging purposes.
	 */
	@Override
	public String toString() {
<span class="nc" id="L275">		Image image = getImage();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		String text = image == null ? null : image.getDescription();</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">		text = text == null ? &quot;null&quot; : ('&quot;' + text + '&quot;');</span>
<span class="nc" id="L278">		return toString(text, 1, 1);</span>
	}

	// --------------------------------
	// Extrinsic state management
	/**
	 * Creates a new component model appropriate for this component.
	 *
	 * @return a new ImageModel.
	 */
	@Override
	protected ImageModel newComponentModel() {
<span class="fc" id="L290">		return new ImageModel();</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	// For type safety only
	protected ImageModel getComponentModel() {
<span class="fc" id="L299">		return (ImageModel) super.getComponentModel();</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	// For type safety only
	protected ImageModel getOrCreateComponentModel() {
<span class="fc" id="L308">		return (ImageModel) super.getOrCreateComponentModel();</span>
	}

	/**
	 * Holds the extrinsic state information of a WImage.
	 */
<span class="fc" id="L314">	public static class ImageModel extends BeanAndProviderBoundComponentModel {</span>

		private Image image;
		private String cacheKey;
		private String imageUrl;
		private String alternativeText;
		private Dimension size;
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>